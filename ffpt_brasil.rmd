---
title: Exploratory Analysis of Municipalities in Brazil that have adopted a Fare Free Public Transport
author: "Thais Fernandes Pereira"
date: "2021"
output:
  html_document:
    theme: flatly  
    self-contained: true
    toc: true
    toc_float: true
    css:
      - estilo.css
---

```{r setup, include=FALSE, out.width="50%"}
(knitr::opts_chunk$set(echo=FALSE, error=FALSE, warning=FALSE, message=FALSE)) 
```

```{css Estilo do Relatório, eval=FALSE, include=FALSE}

h1.title{ 
    color: #00688B;
    font-size: 23px;
    text-align: center;
    font-weight: bold;
}

h4.author{ 
    color: #00688B;
    font-size: 16px;
    text-align: center;
    font-weight: bold;
}

h4.date{ 
    color: #00688B;
    font-size: 16px;
    text-align: center;
    font-weight: bold;
}

p{
  text-align: justify;
  font-size: 11px
}



```

```{r Pacotes}

library("tidyverse")
library("kableExtra")
library("knitr")
library("tidylog")
library("DT")
library("kableExtra")
library("knitr")
library("tidylog")
library("readxl")
library("geobr")
library("sf")
library("wesanderson")
library("ggplot2")
library("stringr")
library("stargazer")
library ("abjData")
library("extrafont")
library("gganimate")
library("gifski")
library("av")
library("lubridate")
library("transformr")
library("reactable")
library("rnaturalearth")
library("rgeos")
library("plotly")
library("ggrepel")
library("leaflet")

```

```{r baixando arquivos}

# Baixando Arquivos da internet

file1 <- "https://raw.githubusercontent.com/thais01fernandes/C-Users-Thais.Pereira-Documents-pessoal-mestrado-An-lise-Mestrado/main/munic_pop.csv"
munic_pop <- read_delim(file1, delim = ";", 
                         locale = locale(encoding='latin1'))

file2 <- "https://raw.githubusercontent.com/thais01fernandes/C-Users-Thais.Pereira-Documents-pessoal-mestrado-An-lise-Mestrado/main/PIB%20dos%20Munic%C3%ADpios%20-%20base%20de%20dados%202010-2018.csv"
munic_pib <- read_delim(file2, delim = ";", 
                         locale = locale(encoding='latin1'))

file3 <- "https://raw.githubusercontent.com/thais01fernandes/C-Users-Thais.Pereira-Documents-pessoal-mestrado-An-lise-Mestrado/main/idh_muni.csv"
munic_idh <- read_delim(file3, delim = ",")

file4 <- "https://raw.githubusercontent.com/thais01fernandes/C-Users-Thais.Pereira-Documents-pessoal-mestrado-An-lise-Mestrado/main/PlanosdeMobilidadeUrbana.csv"
plano_mob <- read_delim(file4, delim = ",")

file5 <- "https://raw.githubusercontent.com/thais01fernandes/C-Users-Thais.Pereira-Documents-pessoal-mestrado-An-lise-Mestrado/main/ginibr.csv"
munic_gini <- read_delim(file5, delim = ";", 
                         locale = locale(encoding='latin1'))

file6 <- "https://raw.githubusercontent.com/thais01fernandes/Analises-Mestrado/main/dados_ipea.csv"
indice_ipea <- read_delim(file6, delim = ",")

file7 <- "https://raw.githubusercontent.com/thais01fernandes/Analises-Mestrado/main/area_territorial.csv"
area_territorial <- read_delim(file7, delim = ",")


```


```{r Organização da base Parte 1}

# organizando o banco de dados completo com todos os municípios e distiguindo os municícpio com FFPT}
# Os dados do índice de vulnerabilidade econômica foram retirados do site do ipea: http://ivs.ipea.gov.br/index.php/pt/planilha 
# e produzidos com dados do IBGE de 2010. 

indice_ipea$Município <- as.numeric(indice_ipea$Município)

banco_completo <- pnud_muni %>% 
  filter(ano == 2010) %>% 
  select(uf, ufn,municipio, codmun6,codmun7, rdpc, pesourb, pesorur, pesotot, theil, gini, idhm_r, idhm_l, idhm_e, idhm,t_ocupdesloc_1, 	
       pmpob, t_ativ18m) %>% 
  rename(CodMun = codmun7) %>% 
  mutate(tarifa_zero = case_when(CodMun == 3302700 ~ "sim",
                                 CodMun == 2303709~ "sim",
                                 CodMun == 3133709~ "sim",
                                 CodMun == 3519055~ "sim" ,
                                 CodMun == 2304285~ "sim", 
                                 CodMun == 3500709 ~ "sim" , 
                                 CodMun == 3556453~ "sim", 
                                 CodMun == 3528007~ "sim", 
                                 CodMun == 3540804~ "sim" , 
                                 CodMun == 4128500~ "sim", 
                                 CodMun == 4119608~ "sim" , 
                                 CodMun == 4111506~ "sim" , 
                                 CodMun == 3143104~ "sim" ,
                                 CodMun == 3539103~ "sim" , 
                                 CodMun == 3305604~ "sim", 
                                 CodMun == 3144102~ "sim",
                                 CodMun == 3111200~ "sim", 
                                 CodMun == 5201306~ "sim", 
                                 CodMun == 4107603~ "sim", 
                                 CodMun == 3104106~ "sim" ,
                                 CodMun == 3116605~ "sim" , 
                                 CodMun == 3100203~ "sim" ,
                                 CodMun == 5202502~ "sim" , 
                                 CodMun == 3514304~ "sim", 
                                 CodMun == 3511508~ "sim" , 
                                 CodMun == 4314209~ "sim" ,
                                 CodMun == 2301000~ "sim" ,
                                 CodMun == 3532009~ "sim", 
                                 CodMun == 5208004~ "sim", 
                                 CodMun == 3306305~"sim",
                                 CodMun == 3110004~ "sim", TRUE ~ "não")) %>% 
  mutate(tarifa_zero = case_when(CodMun == 3172202~ "não", TRUE ~ tarifa_zero)) %>% 
  left_join(munic_pop, by = "CodMun") %>% 
  select(-`COD UF`, -UF, -`NOME MUNIC`) %>% 
  mutate(`CLASSE POP` = gsub(pattern = "1 -|2 -|3 -|4 -|5 -|6 -|7 -",replacement = "",`CLASSE POP`)) %>% 
  mutate(REGIAO = gsub(pattern = "1 -|2 -|3 -|4 -|5 -",replacement = "", REGIAO)) %>% 
  mutate(`CLASSE POP` = gsub("Até 5000","Até 5.000", `CLASSE POP`)) %>% 
  mutate(`CLASSE POP` = gsub("5001 até 10000","5.000 Até 10.000", `CLASSE POP`)) %>%  
  mutate(`CLASSE POP` = gsub("10001 até 20000","10.000 Até 20.000", `CLASSE POP`)) %>% 
  mutate(`CLASSE POP` = gsub("20001 até 50000","20.000 Até 50.000", `CLASSE POP`)) %>% 
  mutate(`CLASSE POP` = gsub("50001 até 100000","50.000 Até 100.000", `CLASSE POP`)) %>% 
  mutate(`CLASSE POP` = gsub("100001 até 500000","100.000 Até 500.000",`CLASSE POP`)) %>%
  mutate(`CLASSE POP` = gsub("Maior que 500000","Maior que 500.000", `CLASSE POP`)) %>% 
  left_join(indice_ipea, by = c("CodMun" = "Município")) %>% 
  left_join(area_territorial, by = c("CodMun"))
 
  
```

```{r Organização da base Parte 2}

# Criando um data frame com o ano de implatanção da Política

# Essa informação foi coletada da dissertação de Mestrado de Marijke Vermander, "EXPLORING FARE-FREE PUBLIC
# TRANSPORT IN BRAZIL Rationales and characteristics of Tarifa Zero policies in small Brazilian municipalities, 2021"

ano_implementacao <- tibble(CodMun=c(3100203, 3500709, 5201306, 2301000,
                      3104106, 5202502, 3111200, 3511508, 
                      3116605, 3514304, 2304285, 4107603, 3519055,3133709, 
                      4111506, 3528007, 3302700, 3143104, 3532009,3144102,4314209, 
                      3539103,4119608, 3540804,3305604, 3556453,4128500, 5208004, 3110004,2303709, 3306305),
       ano_implementacao=c(1997, 2003, 2014, 2018, 2019, 2008, 2019, 2020, 2021, 
             2014, 2010, 2001, 2010, 2015, 2001, 2004, 2013, 1994,2019,2011,2018,2020, 2012, 1998, 2014,2019, 2008, 2021, 2021, 2021, 2018), 
       ano_implemen_resumido=c("Until 2000s", "Between 2001 and 2009", "Between 2010 and 2015", "Between 2016 and 2021", "Between 2016 and 2021", "Between 2001 and 2009", "Between 2016 and 2021", "Between 2016 and 2021", "Between 2016 and 2021", "Between 2010 and 2015", "Between 2010 and 2015", "Between 2001 and 2009", "Between 2010 and 2015", "Between 2010 and 2015", "Between 2001 and 2009", "Between 2001 and 2009", "Between 2010 and 2015", "Until 2000s", "Between 2016 and 2021", "Between 2010 and 2015", "Between 2016 and 2021", "Between 2016 and 2021", "Between 2010 and 2015", "Until 2000s", "Between 2010 and 2015", "Between 2016 and 2021", "Between 2001 and 2009", "Between 2016 and 2021", "Between 2016 and 2021","Between 2016 and 2021","Between 2016 and 2021"))

banco_completo_1 <- banco_completo %>% 
  left_join(ano_implementacao, by = "CodMun")

```

```{r Organização da base Parte 3}

# PIB dos municípios, IBGE 2018: 
# O banco de dados de PIB contém dados de 2018 e portando mais municípios do que o banco inicial, pnud_muni, que contém dados de 2010

munic_pib_filtrado <- munic_pib %>% 
  filter(Ano == 2018) %>% 
  select(Ano, `Código do Município`,`Produto Interno Bruto per capita, \na preços correntes\n(R$ 1,00)`, `Nome da Grande Região`, `Sigla da Unidade da Federação`) %>% 
  rename(CodMun =`Código do Município`, Pib_Municipal_2018 =`Produto Interno Bruto per capita, \na preços correntes\n(R$ 1,00)`, Regiao = `Nome da Grande Região`, UF = `Sigla da Unidade da Federação`)

banco_completo_2 <- banco_completo_1 %>% 
  left_join(munic_pib_filtrado, by = "CodMun") %>% 
  select(- Ano.y, -Regiao, -`Nome do Município`, -`Município com 6 dígitos`, -Ano.x, -UF.x, - `Nome da UF`) 

```

```{r Organização da base Parte 4}

# Plano de Mobilidade 
# O banco de dados de Plano de Mobilidade contém dados de 2018 e portando mais municípios do que o banco inicial, pnud_muni, que contém dados de 2010
# retirado do site oficial do governo: https://www.gov.br/mdr/pt-br/assuntos/mobilidade-e-servicos-urbanos/planejamento-da-mobilidade-urbana/levantamento-sobre-a-situacao-dos-planos-de-mobilidade-urbana

  plano_mob_1 <- plano_mob %>%
  select (`código do município - IBGE`,`Possui Plano de Mobilidade Urbana`, 
          `Ano de elaboração`, `Aprovado em lei ou ato normativo`,
          `Instrumento Legal`,`Nº da Lei`) %>% 
  rename(CodMun = `código do município - IBGE`)

  plano_mob_1$CodMun <- as.numeric(plano_mob_1$CodMun)

  banco_completo_3 <- banco_completo_2 %>% 
  left_join(plano_mob_1, by = "CodMun")

```

```{r Organização da base Parte 5}

# taxa de urbanização dos municípios com base em dados de estimativa de 2019 do IBGE
# densidade demográfica dos municípios com base em dados da pop de estimativa de 2019 e área total de 2020 do IBGE


  banco_completo_4 <- banco_completo_3 %>% 
  mutate(taxa_urbanizacao = pesourb/pesotot) %>% 
  mutate(densidade_demografica = pesotot/area_territorial)
  


```

```{r Organização da base Parte 6}

# organização dos dados 

  banco_completo_5 <-banco_completo_4 %>% 
  rename(cod_uf = uf, 
         uf = ufn,
         UF = UF.y,
         nome_muni = municipio, 
         cod_muni_1 = codmun6, 
         renda_percapta_media = rdpc, 
         pop_urbana = pesourb, 
         pop_rural = pesorur, 
         pop_total = pesotot,    
         indice_theil = theil, 
         indice_gini = gini, 
         ocup_desl = t_ocupdesloc_1, 
         pct_pobres = 	pmpob, 
         taxa_atividade_18_anos_ou_mais = t_ativ18m, 
         pop_estimada_2019 = `POP EST`,  
         classe_pop = `CLASSE POP`,
         plano_mob = `Possui Plano de Mobilidade Urbana`, 
         ano_elaboracao = `Ano de elaboração`, 
         pop_total_2010 = pesotot,
         indice_ivs = IVS, 
         ivs_infra_urbana = `IVS Infraestrutura Urbana`, 
         ivs_capital_humano = `IVS Capital Humano`, 
         ivs_renda_trabalho = `IVS Renda e Trabalho`,
         pct_domicilios_agua_esgosto_sanitario_inadequado = `% de pessoas em domicílios com abastecimento de água e esgotamento sanitário inadequados`,
         pct_pop_domicilios_urbanos_sem_coleta_lixo = `% da população que vive em domicílios urbanos sem o serviço de coleta de lixo`, 
         prosperidade_social = `Prosperidade Social`, 
         pop_vulneravel_retorna_diariamente_trabalho = `População ocupada vulnerável à pobreza que retorna diariamente do trabalho`, 
         pct_formalizacao_18_ou_mais = `Grau de formalização dos ocupados - 18 anos ou mais`) %>% 
  select(REGIAO, 
       UF, 
       uf, 
       cod_uf, 
       nome_muni, 
       cod_muni_1, 
       CodMun, 
       tarifa_zero, 
       ano_implementacao, 
       ano_implemen_resumido, 
       renda_percapta_media, 
       Pib_Municipal_2018, 
       pct_pobres,  
       ocup_desl, 
       taxa_atividade_18_anos_ou_mais, 
       classe_pop,
       prosperidade_social, 
       pop_urbana, 
       area_territorial, 
       densidade_demografica,
       pop_rural,taxa_urbanizacao,
       pct_domicilios_agua_esgosto_sanitario_inadequado,
       pct_pop_domicilios_urbanos_sem_coleta_lixo,
       pop_vulneravel_retorna_diariamente_trabalho, 
       pct_formalizacao_18_ou_mais, 
       pop_estimada_2019, 
       pop_total_2010,
       indice_ivs, 
       ivs_infra_urbana, 
       ivs_capital_humano, 
       ivs_renda_trabalho, 
       indice_theil, 
       indice_gini, 
       idhm, idhm_e,  
       idhm_l, idhm_r,
       plano_mob,
       ano_elaboracao,
       `Aprovado em lei ou ato normativo`,
       `Instrumento Legal`, `Nº da Lei`)  %>% 
  mutate(idhm_class = case_when(idhm > 0 & idhm <= 0.499 ~ "Very Low", 
                                        idhm  >= 0.500 & idhm <= 0.599 ~ "Low", 
                                        idhm  >= 0.600 & idhm <= 0.699 ~ "Medium", 
                                        idhm  >= 0.700 & idhm <= 0.799 ~"High", 
                                        idhm  >= 0.800 ~ "Very High", TRUE ~ "idhm")) %>% 
  mutate(idhm_r_class = case_when(idhm_r > 0 & idhm_r <= 0.499 ~ "Very Low", 
                                        idhm_r  >= 0.500 & idhm_r <= 0.599 ~ "Low", 
                                        idhm_r  >= 0.600 & idhm_r <= 0.699 ~ "Medium", 
                                        idhm_r  >= 0.700 & idhm_r <= 0.799 ~"High", 
                                        idhm_r  >= 0.800 ~ "Very High", TRUE ~ "idhm")) %>% 
  mutate(idhm_e_class = case_when(idhm_e > 0 & idhm_e <= 0.499 ~ "Very Low", 
                                        idhm_e  >= 0.500 & idhm_e <= 0.599 ~ "Low", 
                                        idhm_e  >= 0.600 & idhm_e <= 0.699 ~ "Medium", 
                                        idhm_e  >= 0.700 & idhm_e <= 0.799 ~"High", 
                                        idhm_e  >= 0.800 ~ "Very High", TRUE ~ "idhm")) %>% 
  mutate(idhm_l_class = case_when(idhm_l > 0 & idhm_l <= 0.499 ~ "Very Low", 
                                        idhm_l  >= 0.500 & idhm_l <= 0.599 ~ "Low", 
                                        idhm_l  >= 0.600 & idhm_l <= 0.699 ~ "Medium", 
                                        idhm_l  >= 0.700 & idhm_l <= 0.799 ~"High", 
                                        idhm_l  >= 0.800 ~ "Very High", TRUE ~ "idhm")) %>% 
  mutate(ivs_class = case_when(indice_ivs >= 0 & indice_ivs <= 0.200 ~ "Very Low", 
                                         indice_ivs  >= 0.201 & indice_ivs <= 0.300 ~ "Low", 
                                         indice_ivs  >= 0.301 & indice_ivs <= 0.400 ~ "Medium", 
                                         indice_ivs  >= 0.401 ~"High", TRUE ~ "indice_ivs")) %>% 
   mutate(ivs_infra_urbana_class = case_when(ivs_infra_urbana >= 0 & ivs_infra_urbana <= 0.200 ~ "Very Low", 
                                        ivs_infra_urbana  >= 0.201 & ivs_infra_urbana <= 0.300 ~ "Low", 
                                        ivs_infra_urbana  >= 0.301 & ivs_infra_urbana <= 0.400 ~ "Medium", 
                                        ivs_infra_urbana  >= 0.401 ~"High",  TRUE ~ "indice_ivs")) %>% 
  mutate(ivs_renda_trab_class = case_when(ivs_renda_trabalho >= 0 & ivs_renda_trabalho <= 0.200 ~ "Very Low", 
                                       ivs_renda_trabalho  >= 0.201 & ivs_renda_trabalho <= 0.300 ~ "Low", 
                                       ivs_renda_trabalho  >= 0.301 & ivs_renda_trabalho <= 0.400 ~ "Medium", 
                                       ivs_renda_trabalho  >= 0.401 ~"High",  TRUE ~ "indice_ivs")) %>% 
  mutate(ivs_cap_class = case_when(ivs_capital_humano >= 0 & ivs_capital_humano <= 0.200 ~ "Very Low", 
                                       ivs_capital_humano  >= 0.201 & ivs_capital_humano <= 0.300 ~ "Low", 
                                       ivs_capital_humano  >= 0.301 & ivs_capital_humano <= 0.400 ~ "Medium", 
                                       ivs_capital_humano  >= 0.401 ~"High", TRUE ~ "indice_ivs")) %>% 
  mutate(taxa_pop_vulneravel_retorna_diariamente_trabalho = pop_vulneravel_retorna_diariamente_trabalho/pop_estimada_2019)


# transformando algumas variáveis em numéricas:

banco_completo_5[21:30] <- lapply(banco_completo_5[21:30], as.numeric)


```


## Abstract

This report analyse data from 31 Brazilian cities that have adopted the full fare exemption on public transport, more popularly known in Brazil as the "Tarifa Zero", a term that will be used in this report to refer to this policy. For the selection of cases, two criteria were used: i. The policy was implemented in all transport networks in the city; ii. It is available to all users. We intend to present an exploratory analysis of public data about the studied municipalities and characterize them by checking if there is homogeneity in their economic and social characteristics, in addition to comparing them with all others that have not adopted the policy, with the objective to understand the differences and disparities between the two groups of cities.  


## 1. Data base

Below is a table with information about the municipalities that have adopted the Tarifa Zero policy. The year of implementation was collected from Marijke Vermander's master's thesis (2021), "Exploring Fare-Free Public Transport in Brazil: Rationales and characteristics of Tarifa Zero policies in small Brazilian municipalities". The GDP per capita is IBGE 2018 data, the urbanization rate uses data from the IBGE population estimate for 2019, the population density was produced based on data from this same estimate, however using the total area of the IBGE 2020. Social Vulnerability Index (IVS) data are from IPEA and are published in the "Atlas da Vulnerabilidade Social dos Municípíos Brasileiros" and were produced based on data from the 2010 census. All other data are from the Human Development Index of the municipalities , collected from the "Atlas do Desenvolvimento Humano" and are data from 2010. The AbjData R package (https://abjur.github.io/abjData/) was used, which contains some of these systematized data for all Brazilian municipalities. 


```{r Tabela inicial, fig.align = 'center', out.width = "60%"}

# tabela de apresentação dos municípios estudados 
# tabela com reactable: 
  
  options(scipen=999)
  banco_completo_5  %>% 
  filter(tarifa_zero == "sim") %>% 
  select(UF, nome_muni,ano_implementacao, classe_pop, 
         Pib_Municipal_2018, renda_percapta_media, pct_pobres, prosperidade_social,  
         taxa_atividade_18_anos_ou_mais, taxa_urbanizacao, area_territorial, densidade_demografica, ocup_desl, taxa_pop_vulneravel_retorna_diariamente_trabalho, 
         indice_gini, indice_theil, idhm_class, idhm_e_class, idhm_r_class, idhm_l_class, ivs_class, ivs_infra_urbana_class, ivs_cap_class, ivs_renda_trab_class) %>% 
  mutate_if(is.character, str_to_title) %>% 
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                        UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  mutate(pct_pobres = pct_pobres/100, taxa_atividade_18_anos_ou_mais = taxa_atividade_18_anos_ou_mais/100,
         ocup_desl = ocup_desl/100) %>% 
  arrange(ano_implementacao) %>% 
  reactable(
      defaultPageSize = 5,
      searchable = TRUE,
      outlined = FALSE, 
      showPageInfo = TRUE, 
      showPageSizeOptions = TRUE,
      defaultColDef = colDef(
      align = "center",
      headerStyle = list(background = "#f7f7f8")),
      columns = list(
      UF = colDef("Federative Unit", minWidth = 95, align = "center"),
      nome_muni = colDef("City", minWidth = 120, align = "center"),
      ano_implementacao = colDef("Year of Implementation", minWidth = 140, align = "center"),
      classe_pop = colDef("Population Class",  minWidth = 120, align = "center"),
      Pib_Municipal_2018 = colDef("GDP per Capta" , format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 120),
      renda_percapta_media = colDef("Average Per Capta Income" , format = colFormat(prefix = "R$ ", separators = TRUE), minWidth = 150),
      prosperidade_social = colDef("Social Prosperity", minWidth = 130),
      pct_pobres = colDef("% of Poor" ,  format = colFormat(percent = TRUE, digits = 1), minWidth = 120), 
      taxa_atividade_18_anos_ou_mais = colDef("Economically Active Pouplation (18+)" , format = colFormat(percent = TRUE, digits = 1), minWidth = 200),
      taxa_urbanizacao = colDef("Urbanization Rate" , format = colFormat(percent = TRUE, digits = 1), minWidth = 120),
      ocup_desl = colDef("% of vulnerable to poverty who spend more than an hour to work" , format = colFormat(percent = TRUE, digits = 1), minWidth = 250),
      taxa_pop_vulneravel_retorna_diariamente_trabalho = colDef("% of the employed population vulnerable to poverty that return daily from work" , 
                                                                format = colFormat(percent = TRUE, digits = 1), minWidth = 250), 
      indice_gini = colDef("Gini" ,  minWidth = 100),
      indice_theil = colDef("Theil-L" ,  minWidth = 100),
      idhm_class = colDef("Municipal Human Development Index (MHDI)" ,  minWidth = 150),
      idhm_e_class = colDef("MHDI Education" ,  minWidth = 100),
      idhm_r_class = colDef("MHDI Income" ,  minWidth = 100), 
      idhm_l_class  = colDef("MHDI Longevidade" , minWidth = 120),
      ivs_class = colDef("Social Vulnerability Index (SVI)" , minWidth = 150), 
      ivs_infra_urbana_class = colDef("SVI Urban Infrastructure" , minWidth = 150), 
      ivs_cap_class = colDef("SVI Human Capital" , minWidth = 150), 
      ivs_renda_trab_class = colDef("SVI Income and Work" , minWidth = 150), 
      area_territorial = colDef("Territorial Area" , format = colFormat(suffix = " km²", separators = TRUE), minWidth = 150),
      densidade_demografica = colDef("Demographic Density" , format = colFormat(suffix = " hab/km²", separators = TRUE, digits = 3), minWidth = 150),
      pageSizeOptions = c(5,10,15,20,25,30), bordered = TRUE, striped = FALSE, highlight = TRUE))
     
```

## 2. Localization of municipalities

The map below shows us the location of the cities, the points
represent the municipalities: 

```{r Download GEObr, include=FALSE}

# Download dos Estados e Municípios: 

muni_geobr_1 <- read_municipality(code_muni="all", year=2018)

geo_ufs <- read_state(code_state = 'all', year = 2018)

# Estados: 

  munic_isencao_tarifa_uf <- banco_completo_5 %>% 
  select(cod_uf,tarifa_zero) %>% 
  distinct() %>% 
  rename(code_state=cod_uf)

  geo_ufs_2 <- geo_ufs  %>% 
  left_join(munic_isencao_tarifa_uf, by = c("code_state")) %>% 
  replace(is.na("tarifa_zero"), "não")

# municipios: 

  munic_isencao_tarifa_muni <- banco_completo_5  %>% 
  rename(code_muni= CodMun) %>% 
  select(code_muni,tarifa_zero, ano_implementacao) %>% 
  distinct()

  muni_geobr_3 <- muni_geobr_1 %>% 
  left_join(munic_isencao_tarifa_muni, by = c("code_muni")) %>% 
  replace(is.na("tarifa_zero"), "não") %>% 
  st_centroid() %>% 
  filter(tarifa_zero == "sim") %>% 
  rename (Municipio = name_muni)

```


```{r mapa teste, fig.align = 'center', out.width = "90%"}

# geo_ufs_2 %>% 
#   st_as_sf(coords=c("geom")) %>%
#   ggplot() +
#   geom_sf(aes(geometry = geom),color = "darkgray", fill = "seashell2", alpha = .8)  +
#   geom_sf(data=muni_geobr_3,aes(fill = Municipio), shape = 21,
#           color = "white",
#           fill = "#b783a9",
#           size = 5,
#           alpha = 0.8,
#           show.legend = F) +
#   theme_void() +
#   labs(caption = "") +
#   geom_text_repel(data=muni_geobr_3, aes(label = Municipio, geometry = geom),
#                   stat = "sf_coordinates",
#                   force = 1000,
#                   color = "skyblue4",
#                   max.overlaps = Inf) +
#   theme(plot.caption = element_text(size = 9, vjust = 0.9, family = "serif", color = "#5b6370"))


```



```{r Mapa dos municipios, fig.align = 'center', out.width = "60%"}



# gráfico de mapa colocando os municípios dentro de seus respectivos estados: 

  # geo_ufs_2 %>% 
  # st_as_sf(coords=c("geom")) %>%
  # ggplot() +
  # geom_sf(aes(geometry = geom,
  #            fill = as.character(tarifa_zero)))  +
  # geom_sf(data=muni_geobr_3) +
  # theme_minimal()+
  # scale_fill_manual(values = wes_palette("Moonrise2")) +
  # labs(fill = "Tem política de FFTP?") 
  # 

```


```{r Mapa dos municipios 2, fig.align = 'center', out.width = "90%"}



#  host_cities_plot <-  geo_ufs_2 %>% 
#   st_as_sf(coords=c("geom")) %>%
#   ggplot() +
#   geom_sf(aes(geometry = geom),color = "gray", fill = "seashell2", alpha = .8)  +
#   geom_sf(data=muni_geobr_3,aes(fill = Municipio), shape = 21,
#           color = "white",
#           size = 2,
#           show.legend = F) +
#   theme_minimal()
#  
# 
# 
# ggplotly(host_cities_plot,
#          tooltip = "Municipio",
#          dynamicTicks = F)


```


```{r leaflet map,  fig.align = 'center', out.width = "90%"}

# Primeiro precisamos dos dados de latitude e longitude das cidades analisadas. 
urlfile <- "https://raw.githubusercontent.com/kelvins/Municipios-Brasileiros/master/csv/municipios.csv"
cities_lat_lng <- read.csv(urlfile,encoding = "UTF-8")
# é necessário se certificar que o código de cada cidade estará em formato de texto, para o que a função left_join funcione. 
cities_lat_lng$codigo_ibge <- as.double(cities_lat_lng$codigo_ibge)

ffpt_muni_5 <- banco_completo_5 %>% rename(codigo_ibge = CodMun) %>% 
  left_join(cities_lat_lng, by = "codigo_ibge")

tarifa_zero <- ffpt_muni_5 %>% filter(tarifa_zero == "sim") %>% select(latitude, longitude, nome_muni)

  leaflet(tarifa_zero) %>%
  addTiles() %>% 
  addMarkers(popup= tarifa_zero$nome_muni)



```

This table shows us the region of the municipalities, through it we can see that more than half of them are located in the
southeast of the Brazil. We know that the northeast is the region of Brazil with more municipalities, followed by the southeast region, 
however, the northeast only has 2 municipalities with Tarifa Zero. 

```{r Região dos Municípios,fig.align = 'center', out.width = "50%"}

# Tabela com a Região dos Municípios

  banco_completo_5  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(REGIAO = trimws(REGIAO)) %>% 
  mutate(REGIAO = factor(REGIAO, levels = c("Sudeste", "Sul", "Centro-Oeste", 
        "Nordeste", ordered = T))) %>% 
  group_by(REGIAO) %>%
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  mutate(pct = paste0(round(pct * 100, 0),"%")) %>% 
  select(- n) %>% 
  kable(digits=1, col.names=c("Region", "Proportion of Municipalities")) %>%
  kable_classic_2(full_width = F, html_font = "Cambria")

```

In the table below we can see that among 27 Brazilian states, seven have a municipality that has implemented Tarifa Zero. Minas Gerais is the state with the most municipalities in Brazil but the second with the most cities with Tarifa Zero, and São Paulo is the second with the most municipalities and yet the state with the most cities that have adopted the policy.

```{r UF dos municípios, fig.align = 'center', out.width = "50%"}

# Tabela com a UF dos municípios 

  banco_completo_5  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(UF = trimws(UF)) %>% 
  mutate(UF = factor(UF, levels = c("SP", "MG", "PR", 
        "CE", "GO", "RJ", "RS", ordered = T))) %>% 
  group_by(UF) %>%
  tally() %>%
  mutate(pct = n/sum(n)) %>% 
  mutate(pct = paste0(round(pct * 100, 0),"%")) %>% 
  select(- n) %>% 
  kable(digits=1, col.names=c("Federative Unit", "Proportion of Municipalities")) %>%
  kable_classic_2(full_width = F, html_font = "Cambria")
```

## 3. Population Class

In the table below, we can see the proportion of municipalities in each population class, both municipalities with Tarifa Zero and those that have not adopted the policy. It is possible to observe that most of the municipalities, 37% of them, have a population between 20 and 50 thousand inhabitants while 30% have a population between 10 and 20 thousand inhabitants, that is, most of the municipalities, 67% have a population between 10 and 50 thousand inhabitants, which can be considered "small", among the municipalities that have not adopted the policy, 44% of them are part of this population class. It is interesting to note that there are no municipalities with a population of up to 5,000 inhabitants or more than 500,000 inhabitants that have adopted the Tarifa Zero. 

```{r Classe Populacional dos Municípios, fig.align = 'center', out.width = "65%", dpi=300}

# Tabela com a classe populacional dos municípios 

   munic_interese_classe_pop <- banco_completo_5 %>% 
   filter(tarifa_zero == "sim") %>% 
   group_by(classe_pop) %>% 
   tally() %>% 
   mutate(pct = n/sum(n)) %>% 
   select(- n)
   
 
   munic_geral_classe_pop <- banco_completo_5 %>% 
   filter(tarifa_zero == "não") %>% 
   group_by(classe_pop) %>% 
   tally() %>% 
   mutate(pct = n/sum(n)) %>% 
   select(- n)
   
  munic_interese_classe_pop %>% 
  full_join(munic_geral_classe_pop, by = "classe_pop") %>%
  mutate(classe_pop = trimws(classe_pop)) %>% 
  mutate(pct.x = paste0(round(pct.x * 100, 0),"%")) %>% 
  mutate(pct.y = paste0(round(pct.y * 100, 0),"%")) %>% 
  mutate(pct.x = case_when(classe_pop == "Maior que 500.000" ~ "0%", 
                           classe_pop == "Até 5.000" ~ "0%", TRUE ~ pct.x)) %>%
  mutate(classe_pop = factor(classe_pop, levels = c("Até 5.000", 
                                                    "5.000 Até 10.000", 
                                                    "10.000 Até 20.000", 
                                                    "20.000 Até 50.000",
                                                    "50.000 Até 100.000", 
                                                    "100.000 Até 500.000", 
                                                    "Maior que 500.000", ordered = TRUE))) %>%
   rename("Classe Populacional" = classe_pop, "Municipios com FFPT" = pct.x, "Municipios sem FFPT" = pct.y) %>%
   kable(digits=1, col.names=c("Population Class", 
                               "Municipalities with Tarifa Zero", 
                               "Municipalities without Tarifa Zero")) %>%
   kable_classic_2(full_width = F, html_font = "Cambria") 
   
  

```



```{r Médias Tamanho da Pop}

# População médias 

format_milhar <- function(values, nsmall = 0) {
  values %>%
    as.numeric() %>%
    format(nsmall = nsmall,  big.mark = ".") %>%
    str_trim() 
}

media_pop_ffpt <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(pop_estimada_2019)) %>% 
  round(digits = 0) %>% 
  format_milhar()


media_pop_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(pop_estimada_2019, na.rm = TRUE)) %>% 
  round(digits = 0) %>% 
  format_milhar()
 

max_pop_ffpt <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(max(pop_estimada_2019)) %>% round(digits = 0) %>% 
  format_milhar()

min_pop_ffpt <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(min(pop_estimada_2019)) %>% round(digits = 0) %>% 
  format_milhar()
  
max_pop_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(max(pop_estimada_2019)) %>% round(digits = 0) %>% 
  format_milhar()

```

In the graph below, we can see the estimated population of 2019 by the IBGE for all cities that adopted the Tarifa Zero, together with the national average (vertical line). The population average of the municipalities with the Zero Tariff is `r media_pop_ffpt` thousand inhabitants, with very different amounts, we have a maximum of `r max_pop_ffpt` as is the case of Caucaia in Ceará, and a minimum of `r min_pop_ffpt` inhabitants in Pedro Osório in Rio Grande do Sul (IBGE, 2019). In municipalities that have not adopted the policy, the population average is `r media_pop_geral`, but also with very different values, reaching a maximum of `r max_pop_geral` thousand inhabitants, as is the case of the city of São Paulo. In the chart below, it is possible to compare the municipalities with the Tarifa Zero against each other: 
   

```{r, fig.align = 'center', out.width = "80%", dpi=300}



format_milhar <- function(values, nsmall = 0) {
  values %>%
    as.numeric() %>%
    format(nsmall = nsmall, decimal.mark = ",", big.mark = ".") %>%
    str_trim() %>%
    str_c("", .)
}


# gráfico

options(scipen=999)
banco_completo_5 %>% 
  mutate(media_nacional = mean(pop_estimada_2019)) %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                        UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() + 
  geom_col(aes(x = reorder(nome_muni, pop_estimada_2019), y = pop_estimada_2019, fill = UF),
           width = 1,colour="white", alpha = 0.6) +
  geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  xlab("") +
  ylab("") +
  labs(title = "") + 
  coord_flip()+
  scale_y_continuous(labels = format_milhar) +
  scale_fill_brewer(name = "UF", palette = "Set2")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11, family = "serif"),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.title = element_blank())+
    coord_flip()


```

In the density graph below, we selected only municipalities with less than 250 thousand inhabitants, which corresponds to 97% of Brazilian municipalities, so that the graph would be easier to visualize, in it we can observe the population distribution in the municipalities.  

```{r gráfico de densidade da pop, fig.align = 'center', out.width = "70%", dpi=300}

## formatação em milhar: 

format_milhar <- function(values, nsmall = 0) {
  values %>%
    as.numeric() %>%
    format(nsmall = nsmall, decimal.mark = ",", big.mark = ".") %>%
    str_trim() %>%
    str_c("", .)
}

## gráfico: 

  banco_completo_5 %>%
  filter(pop_estimada_2019 < 250000) %>% 
  ggplot()+
  geom_density(aes(x = pop_estimada_2019, fill = tarifa_zero),  colour="black", alpha = 0.6) +
  labs(title = "") +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#954182"), labels = c("No", "Yes"))+
  theme_minimal()+
    theme(plot.title = element_text(family = "serif", size = 14, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif", size = 12),
    axis.text.x=element_text(size = 10),
    axis.text.y=element_text(size = 10), 
    panel.spacing = unit(0.1, "lines"),
    legend.position = "bottom") +
    scale_x_continuous(labels = format_milhar)

```


## 4. Year of Implementation 

From the graph below, we can see that 70% of the municipalities that adopted Tarifa Zero did so after 2010,
following a global trend already observed by Klebowski (2019), 
however, as shown in the opening table of this report, there are three cases
of municipalities that adopted the policy in the 1990s, such as Monte
Carmelo (MG) which have adopted in 1994, Potirendaba (SP) in 1998 and Abaeté
(MG) in 1997. As well as the four municipalities that permanently adopted the policy in 2021, they are:
Caucaia in Ceará, Caeté and Cláudio in Minhas Gerais and Formosa in Goiania.  

```{r Ano de Implementacao, fig.align = 'center', out.width = "65%", dpi=300}

# Gráfico ano de implementação 

  banco_completo_5  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(ano_implemen_resumido = factor(ano_implemen_resumido, levels = c("Until 2000s", 
                                                                          "Between 2001 and 2009", 
                                                                          "Between 2010 and 2015", 
                                                                          "Between 2016 and 2021", ordered = T))) %>% 
  group_by(ano_implemen_resumido) %>% 
  tally() %>% 
  mutate(pct = n/sum(n)) %>% 
  ggplot(aes(x=ano_implemen_resumido, y = pct)) + 
  geom_col(width = 0.9, fill = "#b9a6b3", colour="white", alpha = 0.9) +
  xlab("") +
  ylab("") +
  ggtitle("") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1))  + 
  geom_label(aes(x =ano_implemen_resumido, y=pct, label = scales::percent(pct, accuracy = 1)), 
           position = position_stack(vjust = 0.8), fill = "beige") +
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 16, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 10.5, family = "serif"),
    axis.text.y=element_text(size = 12, family = "serif"),
    legend.title = element_blank())

```

```{r Médias da Taxa de Urbanização}

# Taxa de urbanização média 

media_urbanizacao_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(taxa_urbanizacao)) %>% 
  round(digits = 2) %>% 
  pull()

media_urbanizacao_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(taxa_urbanizacao, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

min_urbanizacao_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(min(taxa_urbanizacao)) %>% round(digits = 2) %>% 
  pull()

```

## 5. Urbanization Rate

In the graph below we can see an urbanization rate of the studied municipalities, a horizontal line indicates a national average rate of urbanization. 

```{r Taxa de Urbanização, fig.align = 'center', out.width = "80%", dpi=300}


banco_completo_5 %>% 
  mutate(media_nacional = mean(taxa_urbanizacao)) %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                      UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() + 
  geom_col(aes(x = reorder(nome_muni, taxa_urbanizacao), y = taxa_urbanizacao, fill = UF), width = 1,colour="white", alpha = 0.6) +
   geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  xlab("") +
  ylab("") +
  ggtitle("") +
  scale_y_continuous(labels = scales::percent)+
  theme_minimal() + 
    scale_fill_brewer(name = "UF", palette = "Set2")+
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11, family = "serif"),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.title = element_blank())+
    coord_flip()
  

```

There is a difference between the average urbanization rate of municipalities
who adopted Tarifa Zero and those who did not. The average rate of the first group is
`r media_urbanizacao_fftp`% while the second is
`r media_urbanizacao_geral`%. In the first group, two municipalities appear with values that
approximate the average of the second group, Itatiaiuçu (MG) with 62% of
urbanization and Pitanga (PR) with 63%. The other municipalities have
urbanization greater than 70%.

The density graph, below, better illustrates the
distribution of urbanization rates in all municipalities
studied. There is a very large variation in the municipalities that have not adopted the
political, even because they are in much greater quantity, but the interesting thing is to note that the municipalities with Tarifa Zero
are more to the right of the graph, that is, they are mostly well urbanized cities. 


```{r Taxa de Urbanização densidade, echo=FALSE, fig.align = 'center', out.width = "70%", dpi=300}

# Gráfico de densidade da taxa de urbanização 

banco_completo_5  %>% 
  ggplot() +
  geom_density(aes(x= taxa_urbanizacao, fill=tarifa_zero), alpha=0.5) +
  theme_minimal()+
  labs(fill = "Tem Política de FFTP?",
       title = "")+
  scale_x_continuous(labels = scales::percent)+
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#815074"), labels = c("No", "Yes"))+
  theme(plot.title = element_text(family = "serif", size = 14, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11),
    axis.text.y=element_text(size = 11), 
    panel.spacing = unit(0.1, "lines"),
 #   strip.text.x = element_text(size = 6),
    legend.position = "bottom")


```

## 6. Demographic density

The Brazilian demographic density varies a lot, the capitals and large metropolis have a very different demographic density from the small cities in the countryside. The municipalities that adopted the Tarifa Zero policy are generally "small" cities, and therefore with very low population density, in the graph below we can see that only Vargem Grande Paulista in São Paulo reaches 1 inhabitant per km². The national average is 0.5 inhabitant per km², but as we said before, this value can vary a lot and that is why it is very inaccurate. Maybe it's too small because in Brazil the cities are mostly small to medium-sized but nevertheless most of the population is concentrated in capitals and large metropolises.  


```{r densidade demográfica, fig.align = 'center', out.width = "80%", dpi=300}

# formatação  

format_densidade_demografica <- function(values, nsmall = 0) {
  values %>%
    as.numeric() %>%
    format(nsmall = nsmall, decimal.mark = ",", big.mark = ".") %>%
    str_trim() %>%
    str_c(., " hab/km²")
}

# gráfico

banco_completo_5 %>% 
  mutate(media_nacional = mean(densidade_demografica)) %>% 
  mutate(densidade_demografica = round(densidade_demografica, digits = 3))  %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                        UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() + 
  geom_col(aes(x = reorder(nome_muni, densidade_demografica), y = densidade_demografica, fill = UF), width = 1,colour="white", alpha = 0.7) +
   geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  xlab("") +
  ylab("") +
  ggtitle( "") +
  scale_fill_brewer(name = "UF", palette = "Set2")+
  scale_y_continuous(labels = format_densidade_demografica) + 
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11, family = "serif"),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.title = element_blank())+
    coord_flip()

```

In the density graph below, we are showing only Brazilian municipalities with demographic density less than 0.4 inhabitant per km², that is, 93% of the municipalities, so that the graph would not have very discrepant values and, therefore, difficult to visualize. In it, we can observe the concentration of municipalities with a Tarifa Zero on the far right of the graph, which indicates that there is a pattern of lower population density in this group in relation to all others. 


```{r fig.align = 'center', out.width = "70%", dpi=300}

banco_completo_5  %>% filter(densidade_demografica < 0.4) %>% 
  ggplot() +
  geom_density(aes(x= densidade_demografica, fill=tarifa_zero), alpha=0.5) +
  theme_minimal()+
  labs(fill = "Tem Política de FFTP?",
       title = "")+
  scale_x_continuous(labels = format_densidade_demografica) +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#954182"), labels = c("Yes", "No"))+
  theme(plot.title = element_text(family = "serif", size = 14, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11),
    axis.text.y=element_text(size = 11), 
    panel.spacing = unit(0.10, "lines"),
    legend.position = "bottom")

```

## 7. Urban Mobility Plan

An important provision of the National Policy Guidelines Law for
Urban Mobility (Law n.12.587/2012) is the obligation of the
development of urban mobility master plans for all
municipalities with more than 20 thousand inhabitants, according to the standards
established by law, suffering the penalty of not receiving the transfers
intended for the sector in case the plan is not presented within three
years after the enactment of the law, in addition to the requirement to update and
periodic review of the plan. According to a survey by the Ministry of
Cities in 2016, out of a total of 5,569 Brazilian municipalities, 60% meet the 
established criteria by the City Statute and the Law
Mobility, and should therefore develop the plan. Of the municipalities with
Tarifa Zero only 20 have an obligation to develop master plan. In this
analysis we considered only the municipalities that in the survey of
National Secretariat of Mobility and Urban Services (SEMOB) responded
"yes" or "no" to the question about the execution of the mobility plan
urban, not considering the cities that did not respond. Just 13 cities with Tarifa Zero answered yes or no.



```{r Plano de Mobilidade Urbana}

# Tabela plano de mobilidade urbana 1 

   banco_completo_5$plano_mob <- trimws(banco_completo_5$plano_mob)
   banco_completo_5$classe_pop <- trimws(banco_completo_5$classe_pop) # não estava conseguindo filtrar essas variáveis e descobri que o problema eram os espaços 

plano_mob_2 <- banco_completo_5  %>%
   mutate(plano_mob =case_when(plano_mob =="SIM" ~"Sim",
                              TRUE~(plano_mob))) %>% 
  filter(tarifa_zero != "sim" & classe_pop != "10.000 Até 20.000" 
                              & classe_pop != "5.000 Até 10.000" 
                              & classe_pop != "Até 5.000") %>%
  group_by(plano_mob) %>%
  tally() %>% 
  filter(plano_mob != "Nao foi enviado oficio" & 
         plano_mob != "Nao respondeu") %>% 
  mutate(pct_munic_geral = n/sum(n)) %>%
  mutate(percentual = paste0(round(pct_munic_geral * 100, 1),"%")) %>% 
  select(-2, -3)

plano_mob_3 <- banco_completo_5  %>% 
    filter(tarifa_zero == "sim" & classe_pop != "10.000 Até 20.000" 
                                & classe_pop != "5.000 Até 10.000" 
                                & classe_pop != "Até 5.000") %>%  
  group_by(plano_mob) %>% 
  tally() %>% 
  filter(plano_mob != "Nao foi enviado oficio" & 
          plano_mob != "Nao respondeu") %>% 
  mutate(pct_munic_tarifa_zero = n/sum(n)) %>% 
  mutate(percentual = paste0(round(pct_munic_tarifa_zero * 100, 0),"%")) %>% 
  select(-2, -3)
  
  plano_mob_2 %>% 
  full_join(plano_mob_3, by="plano_mob") %>% 
  filter(plano_mob == "Sim") %>% 
  kable(digits=1, col.names=c("Mobility Plan?", 
                              "Municipalities without Tarifa Zero", 
                              "Municipalities with Tarifa Zero")) %>%
  kable_classic_2(full_width = F, html_font = "Cambria")

  

```

These are the seven Municipalities with the Tarifa Zero Policy, which have
urban mobility plan as established by Federal Law number
12587/2012, according to a survey by the National Secretariat for Mobility and
Urban Services (SEMOB), which was last updated in February
2019: 

```{r Plano de Mobilidade Tabela}

# Tabela plano de mobilidade urbana 2

tab_plano_mob <- banco_completo_5  %>% 
  filter(tarifa_zero == "sim") %>%  
  filter(plano_mob == "Sim") %>% 
  select(UF, nome_muni, classe_pop, ano_elaboracao)

tab_plano_mob %>% 
  
  mutate_if(is.character, str_to_title) %>% 
  mutate(UF = case_when(UF == "Mg" ~ "MG", UF == "Sp" ~"SP", UF == "Pr" ~ "PR", TRUE ~ UF)) %>% 
  kable(digits=2, col.names=c("Federative Unit", "Municipality", 
                              "Population Class", 
                              "Year of elaboration ")) %>%
  kable_classic_2(full_width = F, html_font = "Cambria")


```


## 8. Gini and Theil- L Index 


```{r Indice de Gini e Theil media geral}

# Indíce de Gini médias

media_indice_gini_tf <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(indice_gini)) %>% 
  round(digits = 2) %>% 
  pull()

media_indice_gini_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(indice_gini, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

# Indíce de  Theil 

media_indice_theil_tf <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(indice_theil)) %>% 
  round(digits = 2) %>% 
  pull()

media_indice_theil_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(indice_theil, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()



```


Gini and Theil - L are two widely used inequality indices, both measure the
degree of income concentration in a given group and range from 0 to 1,
0 being a situation of complete equality, and 1 being a situation of complete
inequality, in addition both are using data from the 2010 census.
The general average of the Gini index in the studied cities is
 `r media_indice_gini_tf`, while for municipalities without a Zero Tariff it is
`r media_indice_gini_geral`. There is only a small difference in the averages. And the same is true for the
Theil-L index, where the mean in the first group is `r media_indice_theil_tf`, while in the second group it is
de `r media_indice_theil_geral`, but similarly the municipalities with Tarifa Zero present values that indicate less social inequality.
Below we can see the distribution graph of the values of the two indexes for all
the municipalities with a Tarifa Zero: 



```{r grafico ivs infra urbana todos, fig.align = 'center', out.width = "80%", dpi=300}


banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  pivot_longer(cols = c("indice_gini", "indice_theil")) %>%
  group_by(name) %>% 
  mutate(media_nacional = mean(value)) %>% 
  mutate(name = case_when(
    name == "indice_gini" ~ "Gini",
    name == "indice_theil" ~ "Theil-L")) %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                      UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() +
  geom_col(aes(x = reorder(nome_muni, value), y = value, fill = UF), width = 1,colour="white", alpha = 0.6) +
  geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  facet_wrap(~name) +
  theme(legend.position = "bottom") +
  theme_light() +
  labs(fill = "UF",
       title = "") +
  xlab("") +
  ylab("") +
  scale_fill_brewer(name = "UF", palette = "Set2") +
  theme_light() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#b9a6b3"),
    strip.text.x = element_text(colour = "black", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 13),
    axis.text.x=element_text(size = 10, family = "serif"),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.title = element_blank())+
    coord_flip() 

```

In the density graph below it is possible to see that there is
some differences in the distribution of values but they are very small, the curve referring to
cities with Tarifa Zero is more to the left while that of the other cities is more to the right. 

```{r Gráfico GINI e Theil, echo=FALSE, fig.align = 'center', out.width = "75%", dpi=300}

# Gráfico GINI e Theil

banco_completo_5 %>% 
  pivot_longer(cols = c("indice_gini", "indice_theil")) %>%
  mutate(name = case_when(
    name == "indice_gini" ~ "Gini",
    name == "indice_theil" ~ "Theil - L")) %>% 
  ggplot() +
  geom_density(aes(value, fill=tarifa_zero), alpha = 0.5) +
  facet_wrap(~name) +
  theme(legend.position = "bottom") +
  theme_light() +
  labs(fill = "Tem Política de FFTP?",
       title = "") +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#954182"), labels = c("No", "Yes"))+
  theme(plot.title = element_text(family = "serif", size = 14, face = "bold", hjust = 0.5, colour = "black"),
        strip.background = element_rect(colour = "white", fill = "#b9a6b3"),
    strip.text.x = element_text(colour = "#303030", hjust = 0.5, family = "serif", face = "bold",  size = 12),
    text = element_text(family = "serif", size = 13),
    axis.text.x=element_text(size = 10),
    axis.text.y=element_text(size = 11), 
    panel.spacing = unit(0.1, "lines"),
    legend.position = "bottom")

```



```{r media % de pobres}

media_pct_pobres_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(pct_pobres)) %>% 
  round(digits = 2) %>% 
  pull()

media_pct_pobres_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(pct_pobres, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()


```

## 9. Percentage of Poor

The graph below shows the percentage of poor people in each municipality studied and the vertical line represents the national average.
This indicator considers the individual who earns less than R$ 436 
reais as monthly income, which is the recommended poverty line
internationally for use in upper-middle income countries with is the case
from Brazil, and was produced from 2010 census data. There is a considerable difference between the averages found in the
group of cities that have adopted a Tarifa Zero and those that have not. While the
first group has an average percentage of poor from
`r media_pct_pobres_fftp`%, the second group has
`r media_pct_pobres_geral`%, which corresponds to a difference of 14%. 


```{r Porcentagem de pobres, fig.align = 'center', out.width = "80%", dpi=300}

banco_completo_5 %>% 
  mutate(media_nacional = mean(pct_pobres/100)) %>% 
  mutate(pct_pobres = pct_pobres/100) %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                      UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() + 
  geom_col(aes(x = reorder(nome_muni, pct_pobres), y = pct_pobres, fill = UF), width = 1,colour="white", alpha = 0.6) +
   geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  xlab("") +
  ylab("") +
  ggtitle( "") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_brewer(name = "UF", palette = "Set2")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11, family = "serif"),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.title = element_blank())+
    coord_flip()

```

Observing the density graph below, it is also possible to verify how much this percentage 
varies in Brazilian municipalities and also how much the curve of cities that adopted Tarifa Zero is more to the left of the graph.


```{r Porcentagem de Pobres densidade, echo=FALSE, fig.align='center', out.width= "70%", dpi=300}

banco_completo_5 %>% 
  mutate(pct_pobres = pct_pobres/100) %>% 
  ggplot() +
  geom_density(aes(x= pct_pobres , fill=tarifa_zero), alpha=0.5) +
  theme_minimal()+
  labs(fill = "Tem Política de FFPT?",
       title = "") +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#954182"), labels = c("No", "Yes"))+
  theme(plot.title = element_text(family = "serif", size = 14, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11),
    axis.text.y=element_text(size = 11), 
    panel.spacing = unit(0.1, "lines"),
    legend.position = "bottom") +
  scale_x_continuous(labels = scales::percent)
  


```

```{r deslocamento e pobreza médias}

media_deslocamento_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(taxa_pop_vulneravel_retorna_diariamente_trabalho*100)) %>% 
  round(digits = 2) %>% 
  pull()

media_desloc_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(taxa_pop_vulneravel_retorna_diariamente_trabalho*100, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

max_deslocamento_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(max(taxa_pop_vulneravel_retorna_diariamente_trabalho*100)) %>% round(digits = 2) %>% 
  pull()

```

## 10. Urban Displacement and Poverty


```{r medias deslocamento e pobreza}

# % de vulneráveis à pobreza que gastam mais de uma hora até o trabalho

media_desloc_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(ocup_desl)) %>% 
  round(digits = 2) %>% 
  pull()

media_desloc_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(ocup_desl, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

max_urbanizacao_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(max(ocup_desl)) %>% round(digits = 2) %>% 
  pull()

max_urbanizacao_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(max(ocup_desl)) %>% round(digits = 2) %>% 
  pull()


# % da população ocupada vulnerável à pobreza que retorna diariamente do trabalho


media_desloc2_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(taxa_pop_vulneravel_retorna_diariamente_trabalho)) %>% 
  round(digits = 2) %>% 
  pull()

media_desloc2_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(taxa_pop_vulneravel_retorna_diariamente_trabalho, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

max_urbanizacao2_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(max(taxa_pop_vulneravel_retorna_diariamente_trabalho)) %>% round(digits = 2) %>% 
  pull()

max_urbanizacao2_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(max(taxa_pop_vulneravel_retorna_diariamente_trabalho)) %>% round(digits = 2) %>% 
  pull()

```

This displacement and poverty metric in Brazil is data produced from the 2010 census.
The average percentage of the occupied population vulnerable to poverty who return daily from work in municipalities with a Tarifa Zero
is `r media_desloc2_fftp`% while in other municipalities it is `r media_desloc2_geral`%, that is, a little higher but still a very small difference. 
These values reach a maximum of `r max_urbanizacao2_fftp`% in municipalities with Tarifa Zero, while `r max_urbanizacao2_geral`% in other municipalities.
The average percentage of people vulnerable to poverty who spend more than an hour to work, in turn, in municipalities that have adopted the Tarifa Zero
is less than 1%, or more precisely `r media_desloc_fftp`%, while the average in other municipalities is slightly higher,
`r media_desloc_geral`%. In other words, the difference is really very small.
In the first group, this percentage reaches a maximum value of `r max_urbanizacao_fftp`% in the municipality of Caucaia in the 
state of Ceará, while in the other municipalities the maximum of `r max_urbanizacao_geral`%. 


```{r face wrap deslocamento urbano, fig.align='center', out.width= "80%", dpi=300}


  banco_completo_5 %>% 
  mutate(ocup_desl = ocup_desl/100) %>% 
  pivot_longer(cols = c("ocup_desl", "taxa_pop_vulneravel_retorna_diariamente_trabalho")) %>%
  group_by(name) %>% 
  mutate(media_nacional = mean(value)) %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate(name = case_when(
    name == "ocup_desl" ~ "% of vulnerable to poverty who spend more than an hour to work",
    name == "taxa_pop_vulneravel_retorna_diariamente_trabalho" ~ "% of the employed population vulnerable to poverty that return daily from work")) %>%
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                        UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ungroup() %>% 
  ggplot() +
  geom_col(aes(x = reorder(nome_muni, value), y = value, fill = UF), width = 1,colour="white", alpha = 0.6) +
  geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  facet_wrap(~name, labeller = label_wrap_gen(35)) +
  theme(legend.justification  = "bottom") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) + 
  theme_light() +
  labs(fill = "UF",
       title = "") +
  xlab("") +
  ylab("") +
  scale_fill_brewer(name = "UF", palette = "Set2") +
   theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
    strip.background = element_rect(colour = "white", fill = "#b9a6b3"),
    strip.text.x = element_text(colour = "#303030", hjust = 0.5, family = "serif", face = "bold", size = 10),
    axis.text.x=element_text(size = 9, family = "serif"),
    axis.text.y=element_text(size = 8, family = "serif"),
    legend.title = element_blank())+
    coord_flip() 
    


```


## 11. GDP per capita


```{r PIB média geral}

# PIB médio 

media_pib_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(Pib_Municipal_2018)) %>%
  round(digits = 0) %>% 
  pull()

media_pib_2 <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(Pib_Municipal_2018, na.rm = TRUE)) %>% 
  round(digits = 0) %>% 
  pull()

# formatação reais 

format_real <- function(values, nsmall = 0) {
  values %>%
    as.numeric() %>%
    format(nsmall = nsmall, decimal.mark = ",", big.mark = ".") %>%
    str_trim() %>%
    str_c("R$ ", .)
}

media_pib_1 <- format_real(media_pib_1)
media_pib_2 <- format_real(media_pib_2)
  
```

GDP per capita is data produced by IBGE from 2018. The average GDP per capita of the municipalities studied is `r media_pib_1` while the average in Brazilian municipalities that have not adopted the policy is `r media_pib_2`. Looking at this general average, we can say that the GDP per capita of the municipalities that 
adopted the  Tarifa Zero is almost the double of the Brazilian municipalities that did not adopt it, however, when we observe this value by region and federative unit of the country, we verify that these values can vary widely. Below is a graph with all municipalities that adopted the policy together with the national average: 

```{r PIB, fig.align = 'center', out.width = "80%", dpi=300}

# formatação reais 

format_real <- function(values, nsmall = 0) {
  values %>%
    as.numeric() %>%
    format(nsmall = nsmall, decimal.mark = ",", big.mark = ".") %>%
    str_trim() %>%
    str_c("R$ ", .)
}

# mapa

banco_completo_5 %>% 
  mutate(media_nacional = mean(Pib_Municipal_2018)) %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                        UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() + 
  geom_col(aes(x = reorder(nome_muni, Pib_Municipal_2018), y = Pib_Municipal_2018, fill = UF),
           width = 1,colour="white", alpha = 0.6) +
  geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  xlab("") +
  ylab("") +
  labs(title = "") + 
  coord_flip()+
  scale_y_continuous(labels = format_real, breaks=seq(0,15000000,3000000))+
  scale_fill_brewer(name = "UF", palette = "Set2")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 8.5, family = "serif"),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.title = element_blank())+
    coord_flip()


```

Below we have a density graph that compares the distribution of the per capita GDP values of the municipalities that adopted the policy and those that did not. Among the group of cities without the Tarifa Zero, only municipalities with a per capita GDP of less than 20 thousand reais were selected, which corresponds to 99% of the municipalities, so that the graph would not be disproportionate and difficult to visualize, and we can see that, in fact, the municipalities with the policy are more to the right of the graph. 

```{r grafico densidade PIB, fig.align = 'center', out.width = "70%", dpi=300}

## formatação em reais: 

format_real <- function(values, nsmall = 0) {
  values %>%
    as.numeric() %>%
    format(nsmall = nsmall, decimal.mark = ",", big.mark = ".") %>%
    str_trim() %>%
    str_c("R$ ", .)
}

## gráfico: 

banco_completo_5 %>% 
  filter(Pib_Municipal_2018 < 20000000) %>% 
  ggplot()+
  geom_density(aes(x = Pib_Municipal_2018, fill = tarifa_zero),  colour="black", alpha = 0.6) +
  labs(title = "") +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#954182"), labels = c("No", "Yes"))+
  theme_minimal()+
    theme(plot.title = element_text(family = "serif", size = 14, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif", size = 12),
    axis.text.x=element_text(size = 10),
    axis.text.y=element_text(size = 10), 
    panel.spacing = unit(0.1, "lines"),
    legend.position = "bottom") +
    scale_x_continuous(labels = format_real)

```

In the table below we have the average per capita GDP by region in the two groups of municipalities. In it we can observe that the northeast and southeast regions, in fact, the average GDP per capita, in comparison, is much higher, however the cities in the center west and south have lower averages. 


```{r PIB por região}

# Tabela de PIB por região

pib_regiao_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(REGIAO) %>% 
  summarize(media_pib_fftp = mean(Pib_Municipal_2018))

pib_regiao_2 <- banco_completo_5 %>% 
  group_by(REGIAO) %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(media_pib_geral = mean(Pib_Municipal_2018, na.rm = TRUE)) %>% 
  filter(REGIAO != " Norte") 

# Formatação para reais: 

format_real <- function(values, nsmall = 0) {
  values %>%
    as.numeric() %>%
    format(nsmall = nsmall, decimal.mark = ",", big.mark = ".") %>%
    str_trim() %>%
    str_c("R$ ", .)
}

pib_regiao_1$media_pib_fftp <- format_real(pib_regiao_1$media_pib_fftp)
pib_regiao_2$media_pib_geral <- format_real(pib_regiao_2$media_pib_geral)


# Tabela

  pib_regiao_1 %>% full_join(pib_regiao_2, by= "REGIAO") %>% 
  kable(digits=0, col.names=c("Region", "Municipality with Tarifa Zero", "Municipality without Tarifa Zero")) %>%
  kable_classic_2(full_width = F, html_font = "Cambria")
  


```

Here we can see the same data for the states with municipalities that adopted Tarifa Zero. Between the two group we have four states where the GPD is higher in the municipalities with Tarifa Zero: Ceará, Minas Gerais, Rio de Janeiro and São Paulo. The other two, Goiás and Rio Grande do Sul, are the states with lower values, which follows the data by region of the country. 

```{r PIB por Estado}

# Tabela de PIB por Estado

pib_uf_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  group_by(UF) %>% 
  summarize(media_1 = mean(Pib_Municipal_2018))

pib_uf_2 <- banco_completo_5 %>% 
  filter(UF == "CE" | UF == "GO" | UF == "MG" | UF == "PR" | UF == "RJ" | UF == "RS" | UF == "SP") %>% 
  group_by(UF) %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(media_2 = mean(Pib_Municipal_2018))

# formatando para reais

pib_uf_1$media_1 <- format_real(pib_uf_1$media_1)
pib_uf_2$media_2 <- format_real(pib_uf_2$media_2)

# tabela

pib_uf_1 %>% full_join(pib_uf_2, by= "UF") %>% 
  kable(digits=2, col.names=c("Federative Unit","Municipality with Tarifa Zero", "Municipality without Tarifa Zero")) %>%
  kable_classic_2(full_width = F, html_font = "Cambria")

```

## 12. Economically Active Pouplation (18+)


```{r media - taxa de ocupação}

# média da taxa de ocupação  

taxa_ocupação_ffpt <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(media_1 = mean(taxa_atividade_18_anos_ou_mais)) %>% 
  round(digits = 2) %>% 
  pull()


taxa_ocupação_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(media_1 = mean(taxa_atividade_18_anos_ou_mais)) %>% 
  round(digits = 2) %>% 
  pull()


```


The activity rate corresponds to the percentage of the adult population (18 years old or more) who are economically active, that is, who are occupied or who sought work in the month prior to the survey, in this case, the 2010 IBGE survey. average occupancy rate in municipalities with Tarifa Zero is `r taxa_ocupação_ffpt`% while in municipalities without the policy is `r taxa_ocupação_geral`%, therefore slightly higher, but very little difference. The chart below shows the percentage for each municipality, we can see that in general it is above 60% with only the exception of Pedro Osório in Rio Grande do Sul. 


```{r Taxa de Atividade 18 anos ou mais, fig.align = 'center', out.width = "80%", dpi=300}

banco_completo_5 %>% 
  mutate(media_nacional = mean(taxa_atividade_18_anos_ou_mais/100)) %>% 
  mutate(taxa_atividade_18_anos_ou_mais = taxa_atividade_18_anos_ou_mais/100) %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                      UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() + 
  geom_col(aes(x = reorder(nome_muni, taxa_atividade_18_anos_ou_mais), y = taxa_atividade_18_anos_ou_mais, fill = UF),
           width = 1,colour="white", alpha = 0.6) +
  geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  xlab("") +
  ylab("") +
  labs(title = "") + 
  scale_y_continuous(labels = scales::percent) +
  scale_fill_brewer(name = "UF", palette = "Set2") +
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11, family = "serif"),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.title = element_blank())+
    coord_flip()


```

In the density graph below, we can see that municipalities with Tarifa Zero (in purple) are a little more to the right of the graph. 

```{r Taxa de Atividade 18 anos ou mais densidade, fig.align = 'center', out.width = "75%", dpi=300}


banco_completo_5 %>%   
  mutate(taxa_atividade_18_anos_ou_mais = taxa_atividade_18_anos_ou_mais/100) %>% 
  ggplot() +
  geom_density(aes(x= taxa_atividade_18_anos_ou_mais, fill=tarifa_zero), alpha=0.5) +
  theme_minimal()+
  labs(fill = "Tem Política de FFTP?",
       title = "") +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#954182"), labels = c("No", "Yes"))+
  theme(plot.title = element_text(family = "serif", size = 14, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11),
    axis.text.y=element_text(size = 11), 
    panel.spacing = unit(0.1, "lines"),
    legend.position = "bottom") +
  scale_x_continuous(labels = scales::percent) +
  scale_y_continuous(breaks=seq(0,8,2))
  
  
  

```

## 13. Average Per Capita Income


```{r media - renda per capta}

format_real <- function(values, nsmall = 0) {
  values %>%
    as.numeric() %>%
    format(nsmall = nsmall, decimal.mark = ",", big.mark = ".") %>%
    str_trim() %>%
    str_c("R$ ", .)
}


# média da taxa de ocupação  

  renda_per_capta_fftp <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(media_1 = mean(renda_percapta_media)) %>% 
  round(digits = 2) %>% 
  format_real()
 

  renda_per_capta_geral <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(media_1 = mean(renda_percapta_media)) %>% 
  round(digits = 2) %>% 
  format_real()

  renda_per_capta_min <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(media_1 = min(renda_percapta_media)) %>% 
  round(digits = 2) %>% 
  format_real()
  
  renda_per_capta_max <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(media_1 = max(renda_percapta_media)) %>% 
  round(digits = 2) %>% 
  format_real()



```


The average per capita income is the average individual income of all residents of a given municipality. This data is from IBGE and refers to 2010 census.
The average income of the municipalities that adopted Tarifa Zero is `r renda_per_capta_fftp` reais, while for the municipalities that did not adopt the policy  is  
`r renda_per_capta_geral` reais, that is, there is a difference of just over 180 reais. The curve corresponding to municipalities with Tarifa Zero is more to the left in the graph, despite the large variation between these municipalities. The minimum average per capita income is  `r renda_per_capta_min`, in the municipality of Aquirraz in Ceará, while the maximum average per capita income is  `r renda_per_capta_max`, in the municipality of Holambra in São Paulo. 


```{r Renda per capta, fig.align = 'center', out.width = "75%", dpi=300}

banco_completo_5 %>% 
  mutate(media_nacional = mean(renda_percapta_media)) %>% 
  filter(tarifa_zero == "sim") %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                        UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() + 
  geom_col(aes(x = reorder(nome_muni, renda_percapta_media), y = renda_percapta_media, fill = UF),
           width = 1,colour="white", alpha = 0.6) +
  geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  xlab("") +
  ylab("") +
  labs(title = "") + 
  scale_y_continuous(labels = format_real)+
  scale_fill_brewer(name = "UF", palette = "Set2")+
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif"),
    axis.text.x=element_text(size = 11, family = "serif"),
    axis.text.y=element_text(size = 10, family = "serif"),
    legend.title = element_blank())+
    coord_flip()


```

In the density graph below that compares the two groups of municipalities, the difference is very clear, the municipalities with Tarifa Zero again appear more to the right of the graph, with average income per capita, in general, higher. 


```{r Renda percapta média densidade, fig.align = 'center', out.width = "75%", dpi=300}

renda_tarifa_zero <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  select(nome_muni, renda_percapta_media) %>% 
  group_by(nome_muni, renda_percapta_media) %>% 
  tally()


banco_completo_5 %>% 
  ggplot()+
  geom_density(aes(x = renda_percapta_media, fill = tarifa_zero),  colour="black", alpha = 0.6) +
  labs(title = "") +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#954182"), labels = c("No", "Yes"))+
  theme_minimal()+
    theme(plot.title = element_text(family = "serif", size = 14, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif", size = 12),
    axis.text.x=element_text(size = 11),
    axis.text.y=element_text(size = 11), 
    panel.spacing = unit(0.1, "lines"),
    legend.position = "bottom") +
  scale_x_continuous(labels = format_real)



```

## 14. Social Vulnerability Index (SVI)

```{r IVS média geral}

# média 

media_ivs_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(indice_ivs, na.rm = TRUE)) %>% round(digits = 3) %>% 
  pull()

media_ivs_2 <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(indice_ivs, na.rm = TRUE)) %>% round(digits = 3) %>% 
  pull()

# máximo e mínimo

max_ivs_2 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(max(indice_ivs, na.rm = TRUE)) %>% round(digits = 3) %>% 
  pull()

min_ivs_urbano_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(min(indice_ivs, na.rm = TRUE)) %>% round(digits = 3) %>% 
  pull()

# infraestrutura urbana

media_ivs_urbano_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(ivs_infra_urbana, na.rm = TRUE)) %>% round(digits = 3) %>% 
  pull()

media_ivs_urbano_2 <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(ivs_infra_urbana, na.rm = TRUE)) %>% round(digits = 3) %>% 
  pull()


```

According to the Atlas of Social Vulnerability in Brazilian Municipalities, 
published by IPEA in 2015, the Social Vulnerability Index is an index built with
data from the 2010 Brazilian census. These are the variables used for
the construction of the index: 

**1.Urban infrastructure**: Percentage of people in households with inadequate 
water supply and sanitation; percentage of the population living in urban 
households without garbage collection service and percentage of people living in 
households with a per capita income of less than half the minimum wage and who 
spend more than an hour to work in the total number of employed vulnerable and 
who return daily from work. 

**2.Human Capital**: Mortality up to 1 year of age, Percentage of children 
aged 0-5 years who do not attend school; percentage of people aged 6 to 14 
who do not attend school; percentage of women aged 10 to 17 who had children; 
percentage of mothers who are heads of households, without complete primary 
education and with at least one child under 15 years of age, in the total 
number of mothers who are heads of households; illiteracy rate of the population
aged 15 and over; percentage of children living in households where none of 
the residents have completed primary education; percentage of people aged 
15 to 24 who do not study, do not work and have a per capita household income
equal to or less than half the minimum wage (2010), in the total population 
of this age group.   

**3.Income and Work**: proportion of people with per capita household income 
equal to or less than half the minimum wage (2010); unemployment rate for the 
population aged 18 and over; percentage of people aged 18 or over without 
complete elementary school and in informal employment; percentage of people in 
households with per capita income below half the minimum wage
(from 2010) and dependents of the elderly; activity rate of 10 to 14 year olds. 

The index varies between 0 and 1, and the closer to 1, the greater the social 
vulnerability of a municipality. The Atlas also indicates the following 
classification of the values attributed by the index to each municipality: 

-   Between 0 and 0.200 - very low social vulnerability,

-   Between 0.201 and 0.300 - low social vulnerability,

-   Between 0.301 and 0.400 - average social vulnerability,

-   Between 0.401 and 0.500 - are considered to be of high social vulnerability


```{r  ivs tabela}


# munic ffpt:

  ffpt_4 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  select(ivs_class, ivs_cap_class, ivs_renda_trab_class, ivs_infra_urbana_class) %>% 
  pivot_longer(cols = matches("ivs")) %>% 
  group_by(name, value) %>% 
  tally() %>% 
  mutate(ivs_ffpt = n/sum(n)) %>% 
  mutate(percentual = paste0(round(ivs_ffpt * 100, 0),"%")) %>% 
  select(1,2,5) %>% 
  pivot_wider(names_from = value, values_from = percentual)


# munic sem ffpt:

  geral_4 <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  select(ivs_class, ivs_cap_class, ivs_renda_trab_class, ivs_infra_urbana_class) %>% 
  pivot_longer(cols = matches("ivs")) %>% 
  group_by(name, value) %>% 
  tally() %>% 
  mutate(ivs_ffpt = n/sum(n)) %>% 
  mutate(percentual = paste0(round(ivs_ffpt * 100, 0),"%")) %>% 
  select(1,2,5) %>% 
  pivot_wider(names_from = value, values_from = percentual)

# juntando as bases: 

  tbl <- ffpt_4  %>% left_join(geral_4, by = "name") %>% 
    mutate(name = case_when(name == "ivs_class" ~ "General", 
                            name == "ivs_cap_class" ~ "Human Capital", 
                            name == "ivs_infra_urbana_class" ~ "Urban Infrastructure", 
                            name == "ivs_renda_trab_class" ~ "Income and Work", TRUE ~ name))
  
# tabela 

  tbl %>% select(name, High.x, Medium.x, Low.x, `Very Low.x`,  High.y,  Medium.y, Low.y, `Very Low.y`) %>% 
      reactable(
      defaultColDef = colDef(
      align = "center"),
      columns = list(
      name = colDef("Social Vulnerability Index", minWidth = 150),
      High.x = colDef("High", minWidth = 70),
      Low.x = colDef("Low", minWidth = 70),
      Medium.x = colDef("Medium", minWidth = 70), 
      `Very Low.x` = colDef("Very Low", minWidth = 70),
      High.y = colDef("High", minWidth = 70),
      Low.y = colDef("Low", minWidth = 70),
      Medium.y = colDef("Medium", minWidth = 70), 
      `Very Low.y`= colDef("Very Low", minWidth = 70)), 
    columnGroups = list(
    colGroup(name = "Municipalities with Tarifa Zero", columns = c("High.x", "Low.x", "Medium.x", "Very Low.x")),
    colGroup(name = "Municipalities without Tarifa Zero", columns = c("High.y", "Low.y", "Medium.y", "Very Low.y"))))
     
 

```

Taking the IVS classification into account, the average of municipalities that adopted the Tarifa Zero was `r media_ivs_1`, 
which indicates low social vulnerability, and the average in municipalities that did not adopt the policy was
`r media_ivs_2`, which indicates a medium vulnerability situation. The first group also has a maximum value of
`r max_ivs_2` referring to the city of Caucaia in Ceará, representing high social vulnerability, and at the other extreme the value
of `r min_ivs_urbano_1` in the city of Holambra in São Paulo, corresponding to very low social vulnerability. 

```{r ivs face wrap todos, fig.align = 'center', out.width = "80%", dpi=300 }


banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  select(- ivs_class, -ivs_infra_urbana_class, - ivs_renda_trab_class, -ivs_cap_class) %>% 
  pivot_longer(cols = matches("ivs"))  %>% 
  mutate(name = case_when(
    name == "indice_ivs" ~ "General",
    name == "ivs_infra_urbana" ~ "Urban Infrastructure",
    name == "ivs_capital_humano" ~ "Human Capital",
    name == "ivs_renda_trabalho" ~ "Income and Work")) %>% 
  mutate(name = factor(name, levels = c("General", "Urban Infrastructure", "Human Capital", 
        "Income and Work", ordered = T))) %>% 
  group_by(name) %>% 
  mutate(media_nacional = mean(value)) %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                        UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() +
  geom_col(aes(x = reorder(nome_muni, value), y = value, fill = UF), width = 1,colour="white", alpha = 0.6) +
  geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  facet_grid(~name) +
  theme(legend.position = "bottom") +
  theme_bw() +
  labs(fill = "UF",
       title = "") +
  xlab("") +
  ylab("") +
  scale_fill_brewer(name = "UF", palette = "Set2") +
  theme_bw() + 
    theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#b9a6b3"),
    strip.text.x = element_text(colour = "#303030", hjust = 0.5, family = "serif", face = "bold",size = 9),
    axis.text.x=element_text(size = 7, family = "serif"),
    axis.text.y=element_text(size = 7, family = "serif"),
    legend.title = element_blank(),
  legend.position = "bottom") +
    coord_flip() 

```

In the density graph below, we can see that municipalities with Tarifa Zero are more to the left of the graph in relation to all other Brazilian municipalities, which indicates that they are, in general, in a situation of less social vulnerability, with the urban infrastructure indicator being o single with very little difference between the two groups. Comparing the averages of this last indicator we have that the municipalities with Tarifa Zero have the value of `r media_ivs_urbano_1`,
while in the municipalities that have not adopted it is `r media_ivs_urbano_2`, there is very little difference, however it suggests that the first group of cities has better urban infrastructure than the second group. 


```{r grafico ivs, fig.align = 'center', out.width = "70%", dpi=300}


banco_completo_5 %>% 
  select(- ivs_class, -ivs_infra_urbana_class, - ivs_renda_trab_class, -ivs_cap_class) %>% 
  pivot_longer(cols = matches("ivs"))  %>% 
  mutate(tipo = case_when(
    name == "indice_ivs" ~ "General",
    name == "ivs_infra_urbana" ~ "Urban Infrastructure",
    name == "ivs_capital_humano" ~ "Human Capital",
    name == "ivs_renda_trabalho" ~ "Income and Work")) %>% 
  mutate(tipo = factor(tipo, levels = c("General", "Urban Infrastructure", "Human Capital", 
        "Income and Work", ordered = T))) %>% 
  ggplot() +
  geom_density(aes(value, fill=tarifa_zero), alpha = 0.5) +
  facet_wrap(~tipo) +
  theme(legend.position = "bottom") +
  theme_minimal() +
  labs(fill = "Tarifa Zero?",
       title = "") +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#954182"), labels = c("No", "Yes"))+
  theme(plot.title = element_text(family = "serif", size = 13, face = "bold", hjust = 0.5, colour = "black"),
        strip.background = element_rect(colour = "white", fill = "#b9a6b3"),
    strip.text.x = element_text(colour = "#303030", hjust = 0.5, family = "serif", face = "bold"),
    text = element_text(family = "serif", size = 13),
    axis.text.x=element_text(size = 10, colour = "black"),
    axis.text.y= element_blank(), 
    panel.spacing = unit(0.1, "lines"),
    legend.position = "bottom")
 

```


## 15. Municipal Human Development Index (MHDI)

```{r IDHM médias, echo=FALSE}

# IDH dos municípios - média geral 

media_idh_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(idhm)) %>% round(digits = 2) %>% 
  pull()

media_idh_2 <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(idhm, na.rm = TRUE)) %>% round(digits = 2) %>% 
  pull()

# idhm renda

media_idh_renda_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(idhm_r)) %>% 
  round(digits = 2) %>% 
  pull()

media_idh_renda_2 <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(idhm_r, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

# IDHM Educação média

media_idh_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(idhm_e)) %>% 
  round(digits = 2) %>% 
  pull()

media_idh_2 <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(idhm_e, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

# IDH Longevidade média

media_idh_longevidade_1 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  summarize(mean(idhm_l)) %>% 
  round(digits = 2) %>% 
  pull()

media_idh_logenvidade_2 <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  summarize(mean(idhm_l, na.rm = TRUE)) %>% 
  round(digits = 2) %>% 
  pull()

```

"The Municipal Human Development Index" (MHDI) is a measure composed of indicators
from three dimensions of human development:
longevity, education and income, constructed with data from the 2010 Brazilian census.
These are the variables used to build the index:

**1.Income**: Monthly per capita income (BRL)

**2.Education**: Population aged 18 or over who completed elementary school (%);
population aged 5 to 6 years attending school (%); 11 to 13 year old population
attending the final years of elementary school (%); Population 15 to 17 years old with the
complete primary education (%); population from 18 to 20 years of age with complete 
secondary education (%)

**3.Longevity**: Life expectancy at birth (years) 

The index ranges from 0 to 1. The closer to 1, the greater the human development.” (UNDP, 2021).
Below is the classification:

-   Between 0 and 0.499 - very low

-   Between 0.500 and 0.599 - low

-   Between 0.600 and 0.699 - medium

-   Between 0.700 and 0.799 - high

-   Between 0.800 and 1 - very high 


The average MHDI of the studied municipalities is `r media_idh_1`, which indicates "high" MHDI, while the
average in Brazilian municipalities that have not adopted the policy is
`r media_idh_2`, which indicates MHDI "medium". The average of the MHDI Income 
of the studied municipalities is of `r media_idh_renda_1`, that is, "high", while 
the average in Brazilian municipalities that have not adopted the policy is `r media_idh_renda_2`, the medium.
In fact, when we look at the distribution of values in the graph of
density, we noticed that the municipalities that adopted Tarifa Zero present
values closer to 1, being  more to the left of the graphic. The average of the MHDI Education of municipalities with Tarifa Zero is `r media_idh_1`
while the average in Brazilian municipalities that have not adopted the policy
is `r media_idh_2`. So, as in the density graph of the general MHDI and MHDI income, the
municipalities with Tarifa Zero have values closer to 1 and more to the left of the
density graph. Finally, the average of the MHDI longevity of the studied municipalities is of
`r media_idh_longevidade_1` while the average in Brazilian municipalities
that have not adopted the policy is `r media_idh_logenvidade_2`. There is just a small
difference between the two groups, which are in the same "very high" MHDI group. 

```{r tabela idhm}


# munic ffpt:

  ffpt_5 <- banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  select(idhm_class, idhm_r_class, idhm_e_class, idhm_l_class) %>% 
  pivot_longer(cols = matches("idhm")) %>% 
  group_by(name, value) %>% 
  tally() %>% 
  mutate(idhm_ffpt = n/sum(n)) %>% 
  mutate(percentual = paste0(round(idhm_ffpt * 100, 0),"%")) %>% 
  select(1,2,5) %>% 
  pivot_wider(names_from = value, values_from = percentual)


# munic sem ffpt:

  geral_5 <- banco_completo_5 %>% 
  filter(tarifa_zero != "sim") %>% 
  select(idhm_class, idhm_r_class, idhm_e_class, idhm_l_class) %>% 
  pivot_longer(cols = matches("idhm")) %>% 
  group_by(name, value) %>% 
  tally() %>% 
  mutate(idhm_ffpt = n/sum(n)) %>% 
  mutate(percentual = paste0(round(idhm_ffpt * 100, 0),"%")) %>% 
  select(1,2,5) %>% 
  pivot_wider(names_from = value, values_from = percentual)

# juntando as bases: 

  tbl_2 <- ffpt_5  %>% left_join(geral_5, by = "name") %>% 
    mutate(name = case_when(name == "idhm_class" ~ "General", 
                            name == "idhm_r_class" ~ "Income", 
                            name == "idhm_e_class" ~ "Education", 
                            name == "idhm_l_class" ~ "Longevity", TRUE ~ name)) %>% 
    mutate_if(is.character, ~replace(., is.na(.), "0%"))
  
# tabela 

  tbl_2 %>% 
      select(name, High.x, `Very High.x`, Medium.x, Low.x, High.y, `Very High.y`, Medium.y, Low.y, `Very Low`) %>% 
      reactable(
      defaultColDef = colDef(
      align = "center"),
      columns = list(
      name = colDef("Municipal Human development Index", minWidth = 130),
      High.x = colDef("High", minWidth = 70),
      Low.x = colDef("Low", minWidth = 70),
      Medium.x = colDef("Medium", minWidth = 75), 
      `Very High.x` = colDef("Very High", minWidth = 70),
      High.y = colDef("High", minWidth = 70),
      Low.y = colDef("Low", minWidth = 70),
      Medium.y = colDef("Medium", minWidth = 75), 
      `Very High.y` = colDef("Very High", minWidth = 70),
      `Very Low` = colDef("Very Low", minWidth = 65)), 
    columnGroups = list(
    colGroup(name = "Municipalities with Tarifa Zero", columns = c("High.x", "Low.x", "Medium.x", "Very High.x")),
    colGroup(name = "Municipalities without Tarifa Zero", columns = c("High.y", "Low.y", "Medium.y", "Very Low","Very High.y"))))
     

```

Regarding the MHDI indicators: income, education and longevity, we can say that, in terms of income and education, the municipalities that adopted the Tarifa Zero have a difference of 7 points more in the average values of the indicator in relation to municipalities without this policy. Regarding longevity, the averages show practically similar values. 

```{r idhm face wrap todos, fig.align = 'center', out.width = "80%", dpi=300 }


banco_completo_5 %>% 
  filter(tarifa_zero == "sim") %>% 
  select(- idhm_class, - idhm_e_class, - idhm_l_class, -idhm_r_class) %>% 
  pivot_longer(starts_with("idhm")) %>% 
  mutate(name = case_when(
    name == "idhm" ~ "Gerneral",
    name == "idhm_e" ~ "Education",
    name == "idhm_l" ~ "Longevity",
    name == "idhm_r" ~ "Income")) %>% 
  mutate(name = factor(name, levels = c("Gerneral", "Education", "Income", 
        "Longevity", ordered = T))) %>% 
  group_by(name) %>% 
  mutate(media_nacional = mean(value)) %>% 
  mutate_if(is.character, str_to_title) %>%
  mutate(UF = case_when(UF == "Ce" ~ "CE", UF == "Mg" ~ "MG", UF == "Sp" ~"SP", 
                        UF == "Pr" ~ "PR", UF == "Rs" ~"RS", UF == "Go" ~"GO", 
                        UF == "Rj" ~ "RJ", TRUE ~ UF)) %>% 
  ggplot() +
  geom_col(aes(x = reorder(nome_muni, value), y = value, fill = UF), width = 1,colour="white", alpha = 0.6) +
  geom_errorbar(mapping = aes(x = nome_muni, y = media_nacional, ymin = media_nacional, ymax = media_nacional), size = 0.5) +
  facet_grid(~name) +
  theme(legend.position = "bottom") +
  theme_bw() +
  labs(fill = "UF",
       title = "") +
  xlab("") +
  ylab("") +
  scale_fill_brewer(name = "UF", palette = "Set2") +
  theme_light() + 
  theme(plot.title = element_text(family = "serif", size = 12, face = "bold", hjust = 0.5, colour = "black"),
          strip.background = element_rect(colour = "white", fill = "#b9a6b3"),
    strip.text.x = element_text(colour = "#303030", hjust = 0.5, family = "serif", face = "bold",size = 10),
    axis.text.x=element_text(size = 7, family = "serif"),
    axis.text.y=element_text(size = 7, family = "serif"),
    legend.title = element_blank(),
  legend.position = "bottom") +
    coord_flip() 

```

Looking at the distribution of values for the two groups of municipalities we can see that the municipalities that adopted the policy have slightly higher MHDI values. 


```{r Grafico IDHM, fig.align = 'center', out.width = "70%", dpi=300}

# gráfico IDHM

banco_completo_5 %>% 
  select(- idhm_class, - idhm_e_class, - idhm_l_class, -idhm_r_class) %>% 
  pivot_longer(starts_with("idhm")) %>% 
  mutate(tipo = case_when(
    name == "idhm" ~ "General",
    name == "idhm_e" ~ "Education",
    name == "idhm_l" ~ "Longevity",
    name == "idhm_r" ~ "Income")) %>% 
  mutate(tipo = factor(tipo, levels = c("General", "Education", "Income", 
        "Longevity", ordered = T))) %>% 
  ggplot() +
  geom_density(aes(value, fill=tarifa_zero), alpha = 0.5) +
  facet_wrap(~tipo) +
  theme(legend.position = "bottom") +
  theme_minimal() +
  labs(fill = "Tem Política de FFTP?",
       title = "") +
  xlab("") +
  ylab("") +
  scale_fill_manual(name = "Tarifa Zero?", values = c("#00688b", "#954182"), labels = c("No", "Yes"))+
  theme(plot.title = element_text(family = "serif", size = 13, face = "bold", hjust = 0.5, colour = "black"),
    text = element_text(family = "serif", size = 13),
    strip.background = element_rect(colour = "white", fill = "#b9a6b3"),
    strip.text.x = element_text(colour = "#303030", face = "bold", hjust = 0.5, family = "serif"),
    axis.text.x=element_text(size = 10, colour = "black"),
    axis.text.y= element_blank(), 
    panel.spacing = unit(0.1, "lines"),
    legend.position = "bottom")

```

## 16. Social Prosperity

Social Prosperity is an index produced by IPEA and is detailed in the "Atlas of Social Vulnerability of Brazilian Municipalities" (2015), in it we can 
find the following definition: "The integrated analysis of human development with social vulnerability offers what is called here social prosperity. Social prosperity is the simultaneous occurrence of high human development with low social vulnerability, suggesting that in portions of the territory where it takes place, there is a less vulnerable and socially more prosperous human development trajectory. Social prosperity, in this sense, reflects a situation in which human development rests on more robust social bases, where family and school capital, conditions for insertion in the world of work and housing conditions and access to infrastructure urban population are such that there is a perspective of prosperity not only economic, but of living conditions in the social environment." p.74. 

The graph below compares social prosperity in two groups, again the municipalities that adopted the Tarifa Zero (in blue) and those who did not adopt (in purple). In this comparison, we can see that the first group has better levels of social prosperity, with 83% of them concentrated in the High and Very High levels of social prosperity. 

```{r Prosperidade Social , fig.align = 'center', out.width = "75%", dpi=300}

  banco_completo_5  %>% 
  mutate(tarifa_zero = case_when(tarifa_zero == "sim" ~ "Municípios com Tarifa Zero", 
                                 tarifa_zero == "não"~ "Municípios sem Tarifa Zero", TRUE ~ tarifa_zero)) %>% 
  mutate(prosperidade_social = factor(prosperidade_social, levels = c("Muito Alto", "Alto", "Médio", 
        "Baixo", "Muito Baixo", ordered = T))) %>% 
  group_by(tarifa_zero, prosperidade_social) %>% 
  tally() %>% 
  mutate(pct_prosperidade = n/sum(n)) %>% 
  ggplot(aes(x = prosperidade_social, y = pct_prosperidade, fill = tarifa_zero)) + 
  geom_col(width = 0.95, position = "fill", alpha = 0.70) +
  xlab("") +
  ylab("") +
  ggtitle("") +
  scale_y_continuous(labels = scales::percent) + 
  scale_fill_manual(name = "", values = c("#00688b", "#954182"), labels = c("Municipalities with Tarifa Zero", "Municipalities without Tarifa Zero")) + 
  geom_label(aes(x = prosperidade_social, y = pct_prosperidade, group = tarifa_zero, label = scales::percent(pct_prosperidade, accuracy = 1)), 
             position = position_fill(vjust = 0.5),family = "serif", fill = "beige", color = "gray22") +
  theme_minimal() + 
    theme(plot.title = element_text(family = "serif", size = 16, face = "bold", hjust = 0.5, colour = "black"),
   strip.background = element_rect(colour = "white", fill = "palevioletred"),
    strip.text.x = element_text(colour = "black", hjust = 0.5, family = "serif"),
    text = element_text(size = 14, family = "serif", colour = "gray22"),
    axis.text.x=element_text(size = 11, family = "serif"),
    axis.text.y=element_text(size = 11, family = "serif"),
    legend.title = element_blank(),
    legend.position = "bottom")



```

## 17. Social Movements and Tarifa Zero

```{r banco passe livre}

mov_passe_livre <- tibble(CodMun=c(3550308, 4205407, 4209102, 3136702, 3543402, 2507507, 2914802, 3304557, 3549904, 3302205, 3143302, 2111300,  1302603, 3170206, 3539806,5002704, 3518800, 2513703, 2408102, 2704302, 3548500, 4204202, 2927408, 2513851, 3522208, 3520400, 1501402, 5103403,  
3106200, 4314407, 2304400, 1200401, 3525300, 4113700, 3303807, 3304201, 3516309,  3503208),
        nome_movi_passe_livre=c("Passe Livre São Paulo", "Passe Livre Floripa", "Passe Livre Joinville", "Passe Livre Juiz de Fora", "Passe Livre Ribeirão Preto", "Passe Livre João Pessoa", "Passe Livre Itabuna", "Passe Livre Rio de Janeiro", "Passe Livre São José dos Campos", "Passe Livre Itaperuna", "Passe Livre Montes Claros", "Passe Livre Manaus", "Passe Livre Maranhão", "Passe Livre Uberlândia", "Passe Livre Poá", "Passe Livre Mato Grosso do Sul", "Passe Livre Guarulhos", "Passe Livre Santa Rita", "Passe Livre Natal", "Passe Livre Maceió", "Passe Livre Santos", "Passe Livre Chapecó", "Passe Livre Salvador", "Passe Livre Região Grande ABC", "Passe Livre Itapecerica da Serra", "Passe Livre Ilhabela", "Passe Livre Belém","Passe Livre Cuiabá", "Passe Livre Belo Horizonte", "Passe Livre Pelotas", "Passe Livre Fortaleza", "Passe Livre Acre", "Passe Livre Jaú", "Passe Livre Londrina", "Passe Livre Paraty", "Passe Livre Resende", "Passe Livre Francisco Morato", "Passe Livre Araraquara"), 
 data_origem_pl = c(2011, 2011, 2011, 2012, 2012, 2012, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2013, 2014, 2014, 2014, 2015, 2015, 2015, 2016, 2016, 2016, 2017, 2017, 2018, 2018), 
 numero_curtidas_pl = c(301055, 8199, 5637, 201, 3785, 301, 188, 19431, 9850, 318, 84, 1387, 180, 74, 468, 177, 3928, 1218, 626, 150, 745, 50, 5431, 2153, 63,  43, 1356, 287, 6030, 538, 222, 579, 605, 640, 71, 62, 397, 40))

mov_tarifa_zero <- tibble(CodMun = c(2927408,2606200, 2800308, 2913606, 3106200, 4209102, 4106902, 3516200, 3303500, 3506003, 4202404, 3531803), 
                          nome_movi_tarifa_zero = c("Tarifa Zero Salvador", "Tarifa Zero Goiânia", "Tarifa Zero Aracaju", "Tarifa Zero Ilhéus", "Tarifa Zero BH", "Tarifa Zero Joinville", "Tarifa Zero Curitiba", "Tarifa Zero Franca", "Tarifa Zero Nova Iguaçu", "Tarifa Zero Bauru", "Tarifa Zero Blumenau",  "Tarifa Zero de Monte Mor"),
                          data_origem_tf = c(2003, 2011, 2013, 2013, 2013, 2013, 2014, 2014, 2015, 2015, 2016, 2016), 
                          numero_curtidas_tf = c(2610, 1544, 43, 27, 21438, 473, 1073, 305, 106, 387, 528, 23))

banco_completo_6 <- banco_completo_5 %>% 
  left_join(mov_passe_livre, by = "CodMun") %>% 
  left_join(mov_tarifa_zero, by = "CodMun")



```


```{r mapa mov. sociais}

# Estados: 

  ffpt_uf <- banco_completo_6 %>% 
  select(cod_uf,tarifa_zero, nome_movi_passe_livre, nome_movi_tarifa_zero) %>% 
  distinct() %>% 
  rename(code_state=cod_uf)

  geo_ufs_3 <- geo_ufs  %>% 
  left_join(ffpt_uf, by = c("code_state")) %>% 
  replace(is.na("tarifa_zero"), "não")

# municipios: 

  ffpt_muni <- banco_completo_6  %>% 
  rename(code_muni= CodMun) %>% 
  select(code_muni,tarifa_zero, nome_movi_passe_livre, nome_movi_tarifa_zero) %>% 
  distinct()
  
  # camada cidades com tarifa_zero
  
  muni_geobr_4 <- muni_geobr_1 %>% 
  left_join(ffpt_muni, by = c("code_muni")) %>% 
  replace(is.na("tarifa_zero"), "não") %>% 
  st_centroid() %>% 
  filter(tarifa_zero == "sim") %>% 
  rename(`Cidades com Tarifa Zero` = name_muni)
  
  ## camada movimento passe livre
  
  muni_geobr_5 <- muni_geobr_1 %>% 
  left_join(ffpt_muni, by = c("code_muni")) %>% 
  replace(is.na("nome_movi_passe_livre"), "não") %>% 
  st_centroid() %>% 
  filter(nome_movi_passe_livre != "não") %>% 
  rename(`Cidades com Movimento Passe Livre` = nome_movi_passe_livre)
  
  ## camada  movimento tarifa_zero
  
  muni_geobr_6 <- muni_geobr_1 %>% 
  left_join(ffpt_muni, by = c("code_muni")) %>% 
  replace(is.na("nome_movi_tarifa_zero"), "não") %>% 
  st_centroid() %>% 
  filter(nome_movi_tarifa_zero != "não") %>% 
  rename(`Cidades com Movimento Tarifa Zero` = nome_movi_tarifa_zero)
  




```

```{r mapa mov. sociais plot, eval=FALSE, fig.align='center', dpi=300, include=FALSE, out.width="150%"}


# gráfico de mapa colocando os municípios dentro de seus respectivos estados: 
  
  geo_ufs_3 %>% 
  st_as_sf(coords=c("geom")) %>%
  ggplot() +
  geom_sf(aes(geometry = geom), color = "gray", fill = "seashell2")  +
  geom_sf(data=muni_geobr_4, aes(fill = "Cities with Tarifa Zero Policy"), shape = 25,
          color = "white",
          size = 3,
          show.legend = T, 
          alpha = 1) +
  geom_sf(data= muni_geobr_5, aes(fill = "Cities with Passe Livre Movement"), shape = 21,
          color = "white",
          size = 3,
          show.legend = T,
          alpha = 0.8) +
  geom_sf(data= muni_geobr_6, aes(fill = "Cities with Tarifa Zero Movement"), shape = 21,
          color = "white",
          size = 3,
          show.legend = T,
          alpha = 0.8) + 
  theme_void() + 
  labs(fill = "",
       title = "", 
       caption = "")+
   scale_fill_brewer(name = "", palette = "Set1") +
   theme(plot.title = element_text(family = "serif", size = 12, vjust = 0.0010, hjust = 0.5, color = "cornsilk4"),
         plot.caption = element_text(family = "roboto", size = 9, color = "#404040", hjust = 0.9),
         text = element_text(family = "serif", size = 12))
  
   
# ggplotly(host_cities_plot_2,
#          tooltip = "Municipio",
#          dynamicTicks = F)

```

The map below contains the location of social movements that act or acted in Brazil for Tarifa Zero in public transport. The data were collected from the search for pages on facebook. 50 pages of social movements were found, among them, 12 are entitled "Movimento Tarifa Zero", and 38 of them, "Movimento Passe Livre", also bearing the name of the city of origin of the movement. 

```{r tabela icones}


tibble("An icon like this:" = "",
       "equals to" = c("Tarifa Zero Movements",
                        "Cities with Tarifa Zero")) %>% 
  kbl(booktabs = T,
      align = "cl") %>%
  kable_paper(full_width = F,  html_font = "Cambria") %>%
    column_spec(1, image = spec_image(c("https://img.icons8.com/dusk/64/000000/strike.png", "https://img.icons8.com/ios-filled/50/000000/bus.png"), 80,80))

```


```{r, fig.align = 'center', dpi=300}


ffpt_muni_6 <- banco_completo_6 %>% rename(codigo_ibge = CodMun) %>% 
  left_join(cities_lat_lng, by = "codigo_ibge")

tarifa_zero <- ffpt_muni_5 %>% filter(tarifa_zero == "sim") %>% select(latitude, longitude, nome_muni)

passe_livre <- ffpt_muni_6 %>% select(latitude, longitude, nome_movi_passe_livre) %>% 
  filter(!is.na(nome_movi_passe_livre))

movi_tarifa_zero <- ffpt_muni_6 %>% select(latitude, longitude, nome_movi_tarifa_zero) %>% 
  filter(!is.na(nome_movi_tarifa_zero))

# mapa: 

###icone: 

onibus <- makeIcon(
  iconUrl = "https://img.icons8.com/ios-filled/50/000000/bus.png",
  iconWidth = 15, iconHeight = 15)
  
movimentos <- makeIcon(
  iconUrl = "https://img.icons8.com/dusk/64/000000/strike.png",
  iconWidth = 20, iconHeight = 20)
  

  
  leaflet(height=550, width=800) %>% 
  addTiles() %>% 
  addMarkers(data = tarifa_zero,
             label = ~nome_muni,
             icon = onibus,
         #   clusterOptions = markerClusterOptions(),
             popup= paste("<b> Cidade com Tarifa Zero: </b>", tarifa_zero$nome_muni,"<br>")) %>% 
  addMarkers(data = passe_livre,
             label = ~nome_movi_passe_livre,
             icon = movimentos,
           # clusterOptions = markerClusterOptions(),
             popup= paste("<b> Nome do Movimento: </b>", passe_livre$nome_movi_passe_livre,"<br>")) %>% 
    addMarkers(data = movi_tarifa_zero,
             label = ~nome_movi_tarifa_zero,
              icon = movimentos,
           #  clusterOptions = markerClusterOptions(),
             popup= paste("<b> Nome do Movimento: </b>", movi_tarifa_zero$nome_movi_tarifa_zero,"<br>"))



```


The table below shows us some information about the social movement pages found on facebook: 


```{r}

# organizando os dados 

tbl_2 <- banco_completo_6 %>% 
  select(nome_movi_passe_livre, data_origem_pl, numero_curtidas_pl) %>% 
  filter(!is.na(nome_movi_passe_livre)) %>% 
  rename(nome_movi = nome_movi_passe_livre, data_origem = data_origem_pl, numero_curtidas = numero_curtidas_pl)



tbl_3 <- banco_completo_6 %>% 
  select(nome_movi_tarifa_zero, data_origem_tf, numero_curtidas_tf) %>% 
  filter(!is.na(nome_movi_tarifa_zero)) %>% 
  rename(nome_movi = nome_movi_tarifa_zero, data_origem = data_origem_tf, numero_curtidas = numero_curtidas_tf)


  tbl_4 <- tbl_2 %>% full_join(tbl_3, by = c("nome_movi", "data_origem", "numero_curtidas"))


# tabela 

      tbl_4 %>% 
      reactable(defaultPageSize = 7,
      defaultColDef = colDef(
      align = "center"),
      columns = list(
      data_origem = colDef("Date of Origin", minWidth = 100),
      numero_curtidas = colDef("Number of Likes", minWidth = 100),
      nome_movi = colDef("Name of Movement", minWidth = 110)))
     


```

